{"version":3,"file":"relative-position.js","names":["yjs","RelativePosition","constructor","getSelection","selectionChange","saveRelativePosition","doc","_doc$getMap","_doc$getMap$get","_richTexts$get","start","end","clientId","attributeKey","richTexts","getMap","get","has","offset","xmlText","relPos","startOffset","createRelativePositionFromTypeIndex","endOffset","undefined","setAbsolutePosition","_this$relPos","_this$relPos2","_yjs$createAbsolutePo","_yjs$createAbsolutePo2","absStartOffset","createAbsolutePositionFromRelativePosition","index","absEndOffset","PeerRelativePosition","_peerRelativePositions","getPeers","setPeerSelection","_getPeers","_setPeerSelection","_initRelativePositionForPeer","peerId","peer","_peer$start","_peer$end","saveRelativePositions","Object","entries","map","_ref","forEach","setAbsolutePositions"],"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/relative-position.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * @typedef WPBlockSelection\n * @property {string} [clientId]\n * @property {string} [attributeKey]\n * @property {number} [offset]\n */\n\n/**\n * @typedef SelectionRange\n * @property {WPBlockSelection} start\n * @property {WPBlockSelection} end\n */\n\n/**\n * @typedef RelativePositionManager\n * @property {RelativePosition} self\n * @property {PeerRelativePosition} peers\n */\n\n/**\n * Handle the conversion between a Yjs relative position and a Gutenberg absolute position.\n *\n * This is used to maintain a user's caret position so it doesn't look like it's pushed around by remote changes.\n * For example, if my caret is at `ab|c` and a remote user changes the text to `aabc`, I want my\n * caret to \"stay\" relative to the `b` (`aab|c`) instead of staying at the same absolute index (`aa|bc`).\n */\nexport class RelativePosition {\n\t/**\n\t * @param {() => SelectionRange} getSelection - Function to get block editor selection.\n\t * @param {(clientId: string, attributeKey: string, startOffset: number, endOffset: number) => void} selectionChange - Function to set block editor selection.\n\t */\n\tconstructor( getSelection, selectionChange ) {\n\t\tthis.getSelection = getSelection;\n\t\tthis.selectionChange = selectionChange;\n\t}\n\n\t/**\n\t * Get the current block editor selection, convert it to a Y.RelativePosition, and remember it.\n\t *\n\t * Call this method _before_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePosition( doc ) {\n\t\tconst { start, end } = this.getSelection();\n\t\tconst { clientId, attributeKey } = start ?? {};\n\t\tconst richTexts = doc.getMap( 'post' )?.get( 'blocks' )?.get( 'richTexts' );\n\n\t\tif (\n\t\t\trichTexts?.get( clientId )?.has( attributeKey ) &&\n\t\t\ttypeof start.offset === 'number' &&\n\t\t\ttypeof end.offset === 'number'\n\t\t) {\n\t\t\tconst xmlText = richTexts.get( clientId ).get( attributeKey ).get( 'xmlText' );\n\t\t\tthis.relPos = {\n\t\t\t\tclientId,\n\t\t\t\tattributeKey,\n\t\t\t\tstartOffset: yjs.createRelativePositionFromTypeIndex( xmlText, start.offset, -1 ),\n\t\t\t\tendOffset: yjs.createRelativePositionFromTypeIndex( xmlText, end.offset, -1 ),\n\t\t\t};\n\t\t} else {\n\t\t\tthis.relPos = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * If a saved Y.RelativePosition exists, convert it to an absolute position and\n\t * dispatch it as a selection change to the block editor.\n\t *\n\t * Call this method _after_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePosition( doc ) {\n\t\tif ( ! this.relPos?.clientId || ! this.relPos?.attributeKey ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { clientId, attributeKey, startOffset, endOffset } = this.relPos;\n\t\tconst absStartOffset = yjs.createAbsolutePositionFromRelativePosition( startOffset, doc )?.index;\n\t\tconst absEndOffset = yjs.createAbsolutePositionFromRelativePosition( endOffset, doc )?.index;\n\n\t\tif ( typeof absStartOffset !== 'number' || typeof absEndOffset !== 'number' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectionChange( clientId, attributeKey, absStartOffset, absEndOffset );\n\t}\n}\n\nexport class PeerRelativePosition {\n\t/**\n\t * @private\n\t * @type {RelativePosition[]}\n\t */\n\t_peerRelativePositions = [];\n\n\t/**\n\t * @param {() => Record<string, Partial<SelectionRange>>} getPeers\n\t * @param {(peerId: string, selection: SelectionRange) => void} setPeerSelection\n\t */\n\tconstructor( getPeers, setPeerSelection ) {\n\t\t/** @private */\n\t\tthis._getPeers = getPeers;\n\t\t/** @private */\n\t\tthis._setPeerSelection = setPeerSelection;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} peerId\n\t * @param {Partial<SelectionRange>} peer\n\t * @return {RelativePosition}\n\t */\n\t_initRelativePositionForPeer( peerId, peer ) {\n\t\treturn new RelativePosition(\n\t\t\t() => ( { start: peer.start ?? {}, end: peer.end ?? {} } ),\n\t\t\t( clientId, attributeKey, startOffset, endOffset ) =>\n\t\t\t\tthis._setPeerSelection( peerId, {\n\t\t\t\t\tstart: { clientId, attributeKey, offset: startOffset },\n\t\t\t\t\tend: { clientId, attributeKey, offset: endOffset },\n\t\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePositions( doc ) {\n\t\tthis._peerRelativePositions = Object.entries( this._getPeers() ).map( ( [ peerId, peer ] ) =>\n\t\t\tthis._initRelativePositionForPeer( peerId, peer )\n\t\t);\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.saveRelativePosition( doc ) );\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePositions( doc ) {\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.setAbsolutePosition( doc ) );\n\t}\n}\n"],"mappings":"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"}