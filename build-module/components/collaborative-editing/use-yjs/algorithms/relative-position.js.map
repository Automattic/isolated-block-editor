{"version":3,"file":"relative-position.js","names":["yjs","RelativePosition","constructor","getSelection","selectionChange","saveRelativePosition","doc","start","end","clientId","attributeKey","richTexts","getMap","get","has","offset","xmlText","relPos","startOffset","createRelativePositionFromTypeIndex","endOffset","undefined","setAbsolutePosition","absStartOffset","createAbsolutePositionFromRelativePosition","index","absEndOffset","PeerRelativePosition","_peerRelativePositions","getPeers","setPeerSelection","_getPeers","_setPeerSelection","_initRelativePositionForPeer","peerId","peer","saveRelativePositions","Object","entries","map","forEach","setAbsolutePositions"],"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/relative-position.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * @typedef WPBlockSelection\n * @property {string} [clientId]\n * @property {string} [attributeKey]\n * @property {number} [offset]\n */\n\n/**\n * @typedef SelectionRange\n * @property {WPBlockSelection} start\n * @property {WPBlockSelection} end\n */\n\n/**\n * @typedef RelativePositionManager\n * @property {RelativePosition} self\n * @property {PeerRelativePosition} peers\n */\n\n/**\n * Handle the conversion between a Yjs relative position and a Gutenberg absolute position.\n *\n * This is used to maintain a user's caret position so it doesn't look like it's pushed around by remote changes.\n * For example, if my caret is at `ab|c` and a remote user changes the text to `aabc`, I want my\n * caret to \"stay\" relative to the `b` (`aab|c`) instead of staying at the same absolute index (`aa|bc`).\n */\nexport class RelativePosition {\n\t/**\n\t * @param {() => SelectionRange} getSelection - Function to get block editor selection.\n\t * @param {(clientId: string, attributeKey: string, startOffset: number, endOffset: number) => void} selectionChange - Function to set block editor selection.\n\t */\n\tconstructor( getSelection, selectionChange ) {\n\t\tthis.getSelection = getSelection;\n\t\tthis.selectionChange = selectionChange;\n\t}\n\n\t/**\n\t * Get the current block editor selection, convert it to a Y.RelativePosition, and remember it.\n\t *\n\t * Call this method _before_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePosition( doc ) {\n\t\tconst { start, end } = this.getSelection();\n\t\tconst { clientId, attributeKey } = start ?? {};\n\t\tconst richTexts = doc.getMap( 'post' )?.get( 'blocks' )?.get( 'richTexts' );\n\n\t\tif (\n\t\t\trichTexts?.get( clientId )?.has( attributeKey ) &&\n\t\t\ttypeof start.offset === 'number' &&\n\t\t\ttypeof end.offset === 'number'\n\t\t) {\n\t\t\tconst xmlText = richTexts.get( clientId ).get( attributeKey ).get( 'xmlText' );\n\t\t\tthis.relPos = {\n\t\t\t\tclientId,\n\t\t\t\tattributeKey,\n\t\t\t\tstartOffset: yjs.createRelativePositionFromTypeIndex( xmlText, start.offset, -1 ),\n\t\t\t\tendOffset: yjs.createRelativePositionFromTypeIndex( xmlText, end.offset, -1 ),\n\t\t\t};\n\t\t} else {\n\t\t\tthis.relPos = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * If a saved Y.RelativePosition exists, convert it to an absolute position and\n\t * dispatch it as a selection change to the block editor.\n\t *\n\t * Call this method _after_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePosition( doc ) {\n\t\tif ( ! this.relPos?.clientId || ! this.relPos?.attributeKey ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { clientId, attributeKey, startOffset, endOffset } = this.relPos;\n\t\tconst absStartOffset = yjs.createAbsolutePositionFromRelativePosition( startOffset, doc )?.index;\n\t\tconst absEndOffset = yjs.createAbsolutePositionFromRelativePosition( endOffset, doc )?.index;\n\n\t\tif ( typeof absStartOffset !== 'number' || typeof absEndOffset !== 'number' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectionChange( clientId, attributeKey, absStartOffset, absEndOffset );\n\t}\n}\n\nexport class PeerRelativePosition {\n\t/**\n\t * @private\n\t * @type {RelativePosition[]}\n\t */\n\t_peerRelativePositions = [];\n\n\t/**\n\t * @param {() => Record<string, Partial<SelectionRange>>} getPeers\n\t * @param {(peerId: string, selection: SelectionRange) => void} setPeerSelection\n\t */\n\tconstructor( getPeers, setPeerSelection ) {\n\t\t/** @private */\n\t\tthis._getPeers = getPeers;\n\t\t/** @private */\n\t\tthis._setPeerSelection = setPeerSelection;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} peerId\n\t * @param {Partial<SelectionRange>} peer\n\t * @return {RelativePosition}\n\t */\n\t_initRelativePositionForPeer( peerId, peer ) {\n\t\treturn new RelativePosition(\n\t\t\t() => ( { start: peer.start ?? {}, end: peer.end ?? {} } ),\n\t\t\t( clientId, attributeKey, startOffset, endOffset ) =>\n\t\t\t\tthis._setPeerSelection( peerId, {\n\t\t\t\t\tstart: { clientId, attributeKey, offset: startOffset },\n\t\t\t\t\tend: { clientId, attributeKey, offset: endOffset },\n\t\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePositions( doc ) {\n\t\tthis._peerRelativePositions = Object.entries( this._getPeers() ).map( ( [ peerId, peer ] ) =>\n\t\t\tthis._initRelativePositionForPeer( peerId, peer )\n\t\t);\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.saveRelativePosition( doc ) );\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePositions( doc ) {\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.setAbsolutePosition( doc ) );\n\t}\n}\n"],"mappings":"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"}