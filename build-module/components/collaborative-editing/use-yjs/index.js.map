{"version":3,"file":"index.js","names":["createMutex","v4","uuidv4","noop","once","sample","createDocument","useRegistry","useSelect","useEffect","useRef","addCollabFilters","registerCollabFormats","setupUndoManager","PeerRelativePosition","RelativePosition","debug","require","defaultColors","initYDoc","settings","registry","channelId","transport","dispatch","select","mutex","identity","doc","relativePositionManager","self","start","getSelectionStart","end","getSelectionEnd","selectionChange","peers","getCollabPeers","setCollabPeerSelection","sendMessage","message","type","onConnectionReady","setYDoc","getPostMap","onYDocTriggeredChange","changes","updateBlocksWithUndo","blocks","isTriggeredByYDoc","isFirstInChannel","connect","user","name","username","color","caretColor","avatarUrl","onReceiveMessage","data","receiveMessage","selection","setAvailablePeers","setAvailableCollabPeers","startSharing","title","getBlocks","disconnect","window","addEventListener","sendSelection","removeEventListener","useYjs","onSelectionChange","getFormatType","selectionStart","selectionEnd","enabled","console","error","onUnmount","then","current"],"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { createMutex } from 'lib0/mutex';\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, once, sample } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport { createDocument } from './yjs-doc';\n\n/**\n * WordPress dependencies\n */\nimport { useRegistry, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\nimport { setupUndoManager } from './yjs-undo';\nimport { PeerRelativePosition, RelativePosition } from './algorithms/relative-position';\n\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n\nexport const defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {Object} opts\n * @param {import('..').CollaborationSettings} opts.settings\n * @param {Object} opts.registry - Redux data registry for this context.\n */\nasync function initYDoc( { settings, registry } ) {\n\tconst { channelId, transport } = settings;\n\tconst { dispatch, select } = registry;\n\tconst mutex = createMutex();\n\n\t/** @type {string} */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\trelativePositionManager: {\n\t\t\tself: new RelativePosition(\n\t\t\t\t() => ( {\n\t\t\t\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\t\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t\t\t} ),\n\t\t\t\tdispatch( 'core/block-editor' ).selectionChange\n\t\t\t),\n\t\t\tpeers: new PeerRelativePosition(\n\t\t\t\tselect( 'isolated/editor' ).getCollabPeers,\n\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection\n\t\t\t),\n\t\t},\n\t\t/** @param {Object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\t\t},\n\t} );\n\n\tdoc.onConnectionReady(\n\t\tonce( () => {\n\t\t\tdebug( 'Connection ready. Setting up ydoc document and undo manager' );\n\t\t\tdispatch( 'isolated/editor' ).setYDoc( doc );\n\t\t\tsetupUndoManager( doc.getPostMap(), identity, registry );\n\t\t} )\n\t);\n\n\tdoc.onYDocTriggeredChange( ( changes ) => {\n\t\tdebug( 'changes triggered by ydoc, applying to editor state', changes );\n\t\tdispatch( 'isolated/editor' ).updateBlocksWithUndo( changes.blocks, { isTriggeredByYDoc: true } );\n\t} );\n\n\tconst { isFirstInChannel } = await transport.connect( {\n\t\tuser: {\n\t\t\tidentity,\n\t\t\tname: settings.username,\n\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\tavatarUrl: settings.avatarUrl,\n\t\t},\n\t\t/** @param {import('..').CollaborationTransportMessage} data */\n\t\tonReceiveMessage: ( data ) => {\n\t\t\tdebug( 'remote change received by transport', data );\n\n\t\t\tswitch ( data.type ) {\n\t\t\t\tcase 'doc': {\n\t\t\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\t\t\tmutex( () => {\n\t\t\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'selection': {\n\t\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection( data.identity, data.selection );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tsetAvailablePeers: ( peers ) => {\n\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\tdispatch( 'isolated/editor' ).setAvailableCollabPeers( peers );\n\t\t},\n\t\tchannelId,\n\t} );\n\n\tdebug( `connected (channelId: ${ channelId })` );\n\n\tif ( isFirstInChannel ) {\n\t\tdebug( 'first in channel' );\n\n\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\tdoc.startSharing( { title: '', blocks: select( 'core/block-editor' ).getBlocks() } );\n\t} else {\n\t\tdoc.connect();\n\t}\n\n\tconst disconnect = () => {\n\t\ttransport.disconnect();\n\t\tdoc.disconnect();\n\t};\n\n\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\treturn {\n\t\tsendSelection: ( start, end ) => {\n\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\tmutex( () => {\n\t\t\t\tdebug( 'sendSelection', start, end );\n\t\t\t\ttransport.sendMessage( {\n\t\t\t\t\ttype: 'selection',\n\t\t\t\t\tidentity,\n\t\t\t\t\tselection: {\n\t\t\t\t\t\tstart,\n\t\t\t\t\t\tend,\n\t\t\t\t\t},\n\t\t\t\t} );\n\t\t\t} );\n\t\t},\n\t\tdisconnect: () => {\n\t\t\twindow.removeEventListener( 'beforeunload', disconnect );\n\t\t\tdisconnect();\n\t\t},\n\t};\n}\n\n/**\n * @param {Object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst onSelectionChange = useRef( noop );\n\tconst registry = useRegistry();\n\n\tconst { getFormatType, selectionStart, selectionEnd } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\tgetFormatType: select( 'core/rich-text' ).getFormatType,\n\t\t\tselectionStart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\tselectionEnd: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t};\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats( getFormatType );\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tsettings,\n\t\t\tregistry,\n\t\t} ).then( ( { sendSelection, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tonSelectionChange.current = sendSelection;\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tonSelectionChange.current( selectionStart, selectionEnd );\n\t}, [ selectionStart, selectionEnd ] );\n}\n"],"mappings":"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"}