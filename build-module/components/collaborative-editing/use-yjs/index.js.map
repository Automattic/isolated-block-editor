{"version":3,"file":"index.js","names":["createMutex","v4","uuidv4","noop","once","sample","createDocument","useRegistry","useSelect","useEffect","useRef","addCollabFilters","registerCollabFormats","setupUndoManager","PeerRelativePosition","RelativePosition","debug","require","defaultColors","initYDoc","settings","registry","channelId","transport","dispatch","select","mutex","identity","doc","relativePositionManager","self","start","getSelectionStart","end","getSelectionEnd","selectionChange","peers","getCollabPeers","setCollabPeerSelection","sendMessage","message","type","onConnectionReady","setYDoc","getPostMap","onYDocTriggeredChange","changes","updateBlocksWithUndo","blocks","isTriggeredByYDoc","isFirstInChannel","connect","user","name","username","color","caretColor","avatarUrl","onReceiveMessage","data","receiveMessage","selection","setAvailablePeers","setAvailableCollabPeers","startSharing","title","getBlocks","disconnect","window","addEventListener","sendSelection","removeEventListener","useYjs","onSelectionChange","getFormatType","selectionStart","selectionEnd","enabled","console","error","onUnmount","then","current"],"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { createMutex } from 'lib0/mutex';\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, once, sample } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport { createDocument } from './yjs-doc';\n\n/**\n * WordPress dependencies\n */\nimport { useRegistry, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\nimport { setupUndoManager } from './yjs-undo';\nimport { PeerRelativePosition, RelativePosition } from './algorithms/relative-position';\n\n// @ts-ignore\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n\nexport const defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {Object} opts\n * @param {import('..').CollaborationSettings} opts.settings\n * @param {Object} opts.registry - Redux data registry for this context.\n */\nasync function initYDoc( { settings, registry } ) {\n\tconst { channelId, transport } = settings;\n\tconst { dispatch, select } = registry;\n\tconst mutex = createMutex();\n\n\t/** @type {string} */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\trelativePositionManager: {\n\t\t\tself: new RelativePosition(\n\t\t\t\t() => ( {\n\t\t\t\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\t\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t\t\t} ),\n\t\t\t\tdispatch( 'core/block-editor' ).selectionChange\n\t\t\t),\n\t\t\tpeers: new PeerRelativePosition(\n\t\t\t\tselect( 'isolated/editor' ).getCollabPeers,\n\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection\n\t\t\t),\n\t\t},\n\t\t/** @param {Object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\t\t},\n\t} );\n\n\tdoc.onConnectionReady(\n\t\tonce( () => {\n\t\t\tdebug( 'Connection ready. Setting up ydoc document and undo manager' );\n\t\t\tdispatch( 'isolated/editor' ).setYDoc( doc );\n\t\t\tsetupUndoManager( doc.getPostMap(), identity, registry );\n\t\t} )\n\t);\n\n\tdoc.onYDocTriggeredChange( ( changes ) => {\n\t\tdebug( 'changes triggered by ydoc, applying to editor state', changes );\n\t\tdispatch( 'isolated/editor' ).updateBlocksWithUndo( changes.blocks, { isTriggeredByYDoc: true } );\n\t} );\n\n\tconst { isFirstInChannel } = await transport.connect( {\n\t\tuser: {\n\t\t\tidentity,\n\t\t\tname: settings.username,\n\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\tavatarUrl: settings.avatarUrl,\n\t\t},\n\t\t/** @param {import('..').CollaborationTransportMessage} data */\n\t\tonReceiveMessage: ( data ) => {\n\t\t\tdebug( 'remote change received by transport', data );\n\n\t\t\tswitch ( data.type ) {\n\t\t\t\tcase 'doc': {\n\t\t\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\t\t\tmutex( () => {\n\t\t\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'selection': {\n\t\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection( data.identity, data.selection );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tsetAvailablePeers: ( peers ) => {\n\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\tdispatch( 'isolated/editor' ).setAvailableCollabPeers( peers );\n\t\t},\n\t\tchannelId,\n\t} );\n\n\tdebug( `connected (channelId: ${ channelId })` );\n\n\tif ( isFirstInChannel ) {\n\t\tdebug( 'first in channel' );\n\n\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\tdoc.startSharing( { title: '', blocks: select( 'core/block-editor' ).getBlocks() } );\n\t} else {\n\t\tdoc.connect();\n\t}\n\n\tconst disconnect = () => {\n\t\ttransport.disconnect();\n\t\tdoc.disconnect();\n\t};\n\n\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\treturn {\n\t\tsendSelection: ( start, end ) => {\n\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\tmutex( () => {\n\t\t\t\tdebug( 'sendSelection', start, end );\n\t\t\t\ttransport.sendMessage( {\n\t\t\t\t\ttype: 'selection',\n\t\t\t\t\tidentity,\n\t\t\t\t\tselection: {\n\t\t\t\t\t\tstart,\n\t\t\t\t\t\tend,\n\t\t\t\t\t},\n\t\t\t\t} );\n\t\t\t} );\n\t\t},\n\t\tdisconnect: () => {\n\t\t\twindow.removeEventListener( 'beforeunload', disconnect );\n\t\t\tdisconnect();\n\t\t},\n\t};\n}\n\n/**\n * @param {Object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst onSelectionChange = useRef( noop );\n\tconst registry = useRegistry();\n\n\tconst { getFormatType, selectionStart, selectionEnd } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\t// @ts-ignore\n\t\t\tgetFormatType: select( 'core/rich-text' ).getFormatType,\n\t\t\t// @ts-ignore\n\t\t\tselectionStart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\t// @ts-ignore\n\t\t\tselectionEnd: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t};\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats( getFormatType );\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tsettings,\n\t\t\tregistry,\n\t\t} ).then( ( { sendSelection, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tonSelectionChange.current = sendSelection;\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tonSelectionChange.current( selectionStart, selectionEnd );\n\t}, [ selectionStart, selectionEnd ] );\n}\n"],"mappings":"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"}