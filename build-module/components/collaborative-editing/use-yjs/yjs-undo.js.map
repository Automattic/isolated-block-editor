{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-undo.js"],"names":["yjs","debugUndo","require","setupUndoManager","typeScope","identity","registry","dispatch","select","getSelection","start","getSelectionStart","end","getSelectionEnd","setSelection","selectionChange","clientId","attributeKey","offset","undoManager","UndoManager","trackedOrigins","Set","debugUndoWithStackSizes","undoStack","length","redoStack","on","event","selection","stackItem","meta","set","type","get","setUndoManager"],"mappings":"AAAA;AACA;AACA;AACA,OAAO,KAAKA,GAAZ,MAAqB,KAArB;;AAEA,MAAMC,SAAS,GAAGC,OAAO,CAAE,OAAF,CAAP,CAAoB,wBAApB,CAAlB;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,OAAO,SAASC,gBAAT,CAA2BC,SAA3B,EAAsCC,QAAtC,EAAgDC,QAAhD,EAA2D;AACjE,QAAM;AAAEC,IAAAA,QAAF;AAAYC,IAAAA;AAAZ,MAAuBF,QAA7B;;AAEA,QAAMG,YAAY,GAAG,OAAQ;AAC5BC,IAAAA,KAAK,EAAEF,MAAM,CAAE,mBAAF,CAAN,CAA8BG,iBAA9B,EADqB;AAE5BC,IAAAA,GAAG,EAAEJ,MAAM,CAAE,mBAAF,CAAN,CAA8BK,eAA9B;AAFuB,GAAR,CAArB;;AAIA,QAAMC,YAAY,GAAG;AAAA,QAAE;AAAEJ,MAAAA,KAAF;AAASE,MAAAA;AAAT,KAAF;AAAA,WACpBL,QAAQ,CAAE,mBAAF,CAAR,CAAgCQ,eAAhC,CACCL,KADD,aACCA,KADD,uBACCA,KAAK,CAAEM,QADR,EAECN,KAFD,aAECA,KAFD,uBAECA,KAAK,CAAEO,YAFR,EAGCP,KAHD,aAGCA,KAHD,uBAGCA,KAAK,CAAEQ,MAHR,EAICN,GAJD,aAICA,GAJD,uBAICA,GAAG,CAAEM,MAJN,CADoB;AAAA,GAArB;;AAQA,QAAMC,WAAW,GAAG,IAAInB,GAAG,CAACoB,WAAR,CAAqBhB,SAArB,EAAgC;AAAEiB,IAAAA,cAAc,EAAE,IAAIC,GAAJ,CAAS,CAAEjB,QAAF,CAAT;AAAlB,GAAhC,CAApB;;AAEA,QAAMkB,uBAAuB,GAAG,YAAe;AAC9CtB,IAAAA,SAAS,CAAE,YAAF,CAAT;AACAA,IAAAA,SAAS,CAAG,oBAAoBkB,WAAW,CAACK,SAAZ,CAAsBC,MAAQ,UAAUN,WAAW,CAACO,SAAZ,CAAsBD,MAAQ,EAA7F,CAAT;AACA,GAHD;;AAKAN,EAAAA,WAAW,CAACQ,EAAZ,CAAgB,kBAAhB,EAAsCC,KAAF,IAAa;AAChD,UAAMC,SAAS,GAAGpB,YAAY,EAA9B;AACAmB,IAAAA,KAAK,CAACE,SAAN,CAAgBC,IAAhB,CAAqBC,GAArB,CAA0B,gBAA1B,EAA4CH,SAA5C;AACAN,IAAAA,uBAAuB,CAAG,GAAGK,KAAK,CAACK,IAAM,kCAAlB,EAAqDJ,SAArD,CAAvB;AACA,GAJD;AAMAV,EAAAA,WAAW,CAACQ,EAAZ,CAAgB,mBAAhB,EAAuCC,KAAF,IAAa;AACjD,QAAKA,KAAK,CAACK,IAAN,KAAe,MAAf,IAAyBd,WAAW,CAACK,SAAZ,CAAsBC,MAAtB,KAAiC,CAA/D,EAAmE;AAClEF,MAAAA,uBAAuB,CAAG,kEAAH,CAAvB;AACA;AACA;;AAED,UAAMM,SAAS,GAAGD,KAAK,CAACE,SAAN,CAAgBC,IAAhB,CAAqBG,GAArB,CAA0B,gBAA1B,CAAlB;;AAEA,QAAKL,SAAL,aAAKA,SAAL,eAAKA,SAAS,CAAEnB,KAAhB,EAAwB;AACvBI,MAAAA,YAAY,CAAEe,SAAF,CAAZ;AACAN,MAAAA,uBAAuB,CAAG,GAAGK,KAAK,CAACK,IAAM,mCAAlB,EAAsDJ,SAAtD,CAAvB;AACA;AACA;;AAEDN,IAAAA,uBAAuB,CAAG,GAAGK,KAAK,CAACK,IAAM,sCAAlB,CAAvB;AACA,GAfD;AAiBA1B,EAAAA,QAAQ,CAAE,iBAAF,CAAR,CAA8B4B,cAA9B,CAA8ChB,WAA9C;AAEAlB,EAAAA,SAAS,CAAE,0BAAF,CAAT;AACA","sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\nconst debugUndo = require( 'debug' )( 'iso-editor:collab:undo' );\n\n/**\n * Set up undo handling.\n *\n * @param {yjs.AbstractType} typeScope - Yjs type to initialize the undo manager with.\n * @param {string} identity\n * @param {Object} registry - Registry object from `@wordpress/data`.\n */\nexport function setupUndoManager( typeScope, identity, registry ) {\n\tconst { dispatch, select } = registry;\n\n\tconst getSelection = () => ( {\n\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t} );\n\tconst setSelection = ( { start, end } ) =>\n\t\tdispatch( 'core/block-editor' ).selectionChange(\n\t\t\tstart?.clientId,\n\t\t\tstart?.attributeKey,\n\t\t\tstart?.offset,\n\t\t\tend?.offset\n\t\t);\n\n\tconst undoManager = new yjs.UndoManager( typeScope, { trackedOrigins: new Set( [ identity ] ) } );\n\n\tconst debugUndoWithStackSizes = ( ...args ) => {\n\t\tdebugUndo( ...args );\n\t\tdebugUndo( `stack size: undo ${ undoManager.undoStack.length }, redo ${ undoManager.redoStack.length }` );\n\t};\n\n\tundoManager.on( 'stack-item-added', ( event ) => {\n\t\tconst selection = getSelection();\n\t\tevent.stackItem.meta.set( 'caret-location', selection );\n\t\tdebugUndoWithStackSizes( `${ event.type } stack item added with selection`, selection );\n\t} );\n\n\tundoManager.on( 'stack-item-popped', ( event ) => {\n\t\tif ( event.type === 'undo' && undoManager.undoStack.length === 0 ) {\n\t\t\tdebugUndoWithStackSizes( `undo stack item popped (last item, no caret position to restore)` );\n\t\t\treturn;\n\t\t}\n\n\t\tconst selection = event.stackItem.meta.get( 'caret-location' );\n\n\t\tif ( selection?.start ) {\n\t\t\tsetSelection( selection );\n\t\t\tdebugUndoWithStackSizes( `${ event.type } stack item popped with selection`, selection );\n\t\t\treturn;\n\t\t}\n\n\t\tdebugUndoWithStackSizes( `${ event.type } stack item popped without selection` );\n\t} );\n\n\tdispatch( 'isolated/editor' ).setUndoManager( undoManager );\n\n\tdebugUndo( 'instantiated UndoManager' );\n}\n"],"file":"yjs-undo.js"}