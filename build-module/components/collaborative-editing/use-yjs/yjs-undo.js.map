{"version":3,"file":"yjs-undo.js","names":["yjs","debugUndo","require","setupUndoManager","typeScope","identity","registry","dispatch","select","getSelection","start","getSelectionStart","end","getSelectionEnd","setSelection","selectionChange","clientId","attributeKey","offset","undoManager","UndoManager","trackedOrigins","Set","debugUndoWithStackSizes","args","undoStack","length","redoStack","on","event","selection","stackItem","meta","set","type","get","setUndoManager"],"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-undo.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\nconst debugUndo = require( 'debug' )( 'iso-editor:collab:undo' );\n\n/**\n * Set up undo handling.\n *\n * @param {yjs.AbstractType} typeScope - Yjs type to initialize the undo manager with.\n * @param {string} identity\n * @param {Object} registry - Registry object from `@wordpress/data`.\n */\nexport function setupUndoManager( typeScope, identity, registry ) {\n\tconst { dispatch, select } = registry;\n\n\tconst getSelection = () => ( {\n\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t} );\n\tconst setSelection = ( { start, end } ) =>\n\t\tdispatch( 'core/block-editor' ).selectionChange(\n\t\t\tstart?.clientId,\n\t\t\tstart?.attributeKey,\n\t\t\tstart?.offset,\n\t\t\tend?.offset\n\t\t);\n\n\tconst undoManager = new yjs.UndoManager( typeScope, { trackedOrigins: new Set( [ identity ] ) } );\n\n\tconst debugUndoWithStackSizes = ( ...args ) => {\n\t\t// @ts-ignore\n\t\tdebugUndo( ...args );\n\t\tdebugUndo( `stack size: undo ${ undoManager.undoStack.length }, redo ${ undoManager.redoStack.length }` );\n\t};\n\n\tundoManager.on( 'stack-item-added', ( event ) => {\n\t\tconst selection = getSelection();\n\t\tevent.stackItem.meta.set( 'caret-location', selection );\n\t\tdebugUndoWithStackSizes( `${ event.type } stack item added with selection`, selection );\n\t} );\n\n\tundoManager.on( 'stack-item-popped', ( event ) => {\n\t\tif ( event.type === 'undo' && undoManager.undoStack.length === 0 ) {\n\t\t\tdebugUndoWithStackSizes( `undo stack item popped (last item, no caret position to restore)` );\n\t\t\treturn;\n\t\t}\n\n\t\tconst selection = event.stackItem.meta.get( 'caret-location' );\n\n\t\tif ( selection?.start ) {\n\t\t\tsetSelection( selection );\n\t\t\tdebugUndoWithStackSizes( `${ event.type } stack item popped with selection`, selection );\n\t\t\treturn;\n\t\t}\n\n\t\tdebugUndoWithStackSizes( `${ event.type } stack item popped without selection` );\n\t} );\n\n\tdispatch( 'isolated/editor' ).setUndoManager( undoManager );\n\n\tdebugUndo( 'instantiated UndoManager' );\n}\n"],"mappings":"AAAA;AACA;AACA;AACA,OAAO,KAAKA,GAAG,MAAM,KAAK;AAE1B,MAAMC,SAAS,GAAGC,OAAO,CAAE,OAAQ,CAAC,CAAE,wBAAyB,CAAC;;AAEhE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,gBAAgBA,CAAEC,SAAS,EAAEC,QAAQ,EAAEC,QAAQ,EAAG;EACjE,MAAM;IAAEC,QAAQ;IAAEC;EAAO,CAAC,GAAGF,QAAQ;EAErC,MAAMG,YAAY,GAAGA,CAAA,MAAQ;IAC5BC,KAAK,EAAEF,MAAM,CAAE,mBAAoB,CAAC,CAACG,iBAAiB,CAAC,CAAC;IACxDC,GAAG,EAAEJ,MAAM,CAAE,mBAAoB,CAAC,CAACK,eAAe,CAAC;EACpD,CAAC,CAAE;EACH,MAAMC,YAAY,GAAGA,CAAE;IAAEJ,KAAK;IAAEE;EAAI,CAAC,KACpCL,QAAQ,CAAE,mBAAoB,CAAC,CAACQ,eAAe,CAC9CL,KAAK,EAAEM,QAAQ,EACfN,KAAK,EAAEO,YAAY,EACnBP,KAAK,EAAEQ,MAAM,EACbN,GAAG,EAAEM,MACN,CAAC;EAEF,MAAMC,WAAW,GAAG,IAAInB,GAAG,CAACoB,WAAW,CAAEhB,SAAS,EAAE;IAAEiB,cAAc,EAAE,IAAIC,GAAG,CAAE,CAAEjB,QAAQ,CAAG;EAAE,CAAE,CAAC;EAEjG,MAAMkB,uBAAuB,GAAGA,CAAE,GAAGC,IAAI,KAAM;IAC9C;IACAvB,SAAS,CAAE,GAAGuB,IAAK,CAAC;IACpBvB,SAAS,CAAG,oBAAoBkB,WAAW,CAACM,SAAS,CAACC,MAAQ,UAAUP,WAAW,CAACQ,SAAS,CAACD,MAAQ,EAAE,CAAC;EAC1G,CAAC;EAEDP,WAAW,CAACS,EAAE,CAAE,kBAAkB,EAAIC,KAAK,IAAM;IAChD,MAAMC,SAAS,GAAGrB,YAAY,CAAC,CAAC;IAChCoB,KAAK,CAACE,SAAS,CAACC,IAAI,CAACC,GAAG,CAAE,gBAAgB,EAAEH,SAAU,CAAC;IACvDP,uBAAuB,CAAG,GAAGM,KAAK,CAACK,IAAM,kCAAiC,EAAEJ,SAAU,CAAC;EACxF,CAAE,CAAC;EAEHX,WAAW,CAACS,EAAE,CAAE,mBAAmB,EAAIC,KAAK,IAAM;IACjD,IAAKA,KAAK,CAACK,IAAI,KAAK,MAAM,IAAIf,WAAW,CAACM,SAAS,CAACC,MAAM,KAAK,CAAC,EAAG;MAClEH,uBAAuB,CAAG,kEAAkE,CAAC;MAC7F;IACD;IAEA,MAAMO,SAAS,GAAGD,KAAK,CAACE,SAAS,CAACC,IAAI,CAACG,GAAG,CAAE,gBAAiB,CAAC;IAE9D,IAAKL,SAAS,EAAEpB,KAAK,EAAG;MACvBI,YAAY,CAAEgB,SAAU,CAAC;MACzBP,uBAAuB,CAAG,GAAGM,KAAK,CAACK,IAAM,mCAAkC,EAAEJ,SAAU,CAAC;MACxF;IACD;IAEAP,uBAAuB,CAAG,GAAGM,KAAK,CAACK,IAAM,sCAAsC,CAAC;EACjF,CAAE,CAAC;EAEH3B,QAAQ,CAAE,iBAAkB,CAAC,CAAC6B,cAAc,CAAEjB,WAAY,CAAC;EAE3DlB,SAAS,CAAE,0BAA2B,CAAC;AACxC"}