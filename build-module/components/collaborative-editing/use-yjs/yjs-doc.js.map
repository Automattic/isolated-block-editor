{"version":3,"file":"yjs-doc.js","names":["yjs","postDocToObject","updatePostDoc","encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","identity","relativePositionManager","sendMessage","doc","Doc","state","yDocTriggeredChangeListeners","connectionReadyListeners","on","update","origin","peers","setAbsolutePositions","newData","sanitize","forEach","listener","self","setAbsolutePosition","isLocalOrigin","UndoManager","protocol","messageType","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","applyLocalChangesToYDoc","data","isInitialContent","richTextHint","saveRelativePositions","transactionOrigin","transact","connect","disconnect","startSharing","receiveMessage","content","encodeStateAsUpdate","applyUpdate","saveRelativePosition","onYDocTriggeredChange","push","filter","l","onConnectionReady","getState","getDoc","getPostMap","getMap"],"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-doc.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * Internal dependencies\n */\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/** @typedef {import('./algorithms/yjs').PostObject} PostObject */\n/** @typedef {import('./algorithms/relative-position').RelativePositionManager} RelativePositionManager */\n/** @typedef {import('..').RichTextHint} RichTextHint */\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\n/**\n * Create a Yjs document.\n *\n * @param {Object} opts\n * @param {RelativePositionManager} opts.relativePositionManager - Module to coordinate conversions between the block editor selection and Y.RelativePosition.\n * @param {string} opts.identity - Client identifier.\n * @param {function(Record<string, unknown>): void} opts.sendMessage\n */\nexport function createDocument( { identity, relativePositionManager, sendMessage } ) {\n\tconst doc = new yjs.Doc();\n\t/** @type {'off'|'connecting'|'on'} */\n\tlet state = 'off';\n\n\tlet yDocTriggeredChangeListeners = [];\n\tlet connectionReadyListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\trelativePositionManager.peers.setAbsolutePositions( doc );\n\n\t\t// Change received from peer, or triggered by self undo/redo\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = postDocToObject( doc, { sanitize: true } );\n\t\t\tyDocTriggeredChangeListeners.forEach( ( listener ) => listener( newData ) );\n\t\t\trelativePositionManager.self.setAbsolutePosition( doc );\n\t\t}\n\n\t\tconst isLocalOrigin =\n\t\t\torigin === identity || origin === `no-undo--${ identity }` || origin instanceof yjs.UndoManager;\n\n\t\t// Change should be broadcast to peers\n\t\tif ( isLocalOrigin && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\n\t\tif ( newState === 'on' ) {\n\t\t\tconnectionReadyListeners.forEach( ( listener ) => listener() );\n\t\t}\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\t/**\n\t\t * @param {PostObject} data\n\t\t * @param {Object} [opts]\n\t\t * @param {boolean} [opts.isInitialContent] Whether this is the initial content loaded from the editor onLoad.\n\t\t * @param {RichTextHint} [opts.richTextHint] Indication that a certain block attribute is a RichText, inferred from the current editor selection.\n\t\t */\n\t\t// @ts-ignore\n\t\tapplyLocalChangesToYDoc( data, { isInitialContent = false, richTextHint } = {} ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\trelativePositionManager.peers.saveRelativePositions( doc );\n\n\t\t\tconst transactionOrigin = isInitialContent ? `no-undo--${ identity }` : identity;\n\n\t\t\tdoc.transact( () => {\n\t\t\t\tupdatePostDoc( doc, data, richTextHint );\n\t\t\t}, transactionOrigin );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\n\t\t\tthis.applyLocalChangesToYDoc( data, { isInitialContent: true } );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif ( content.destination && content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray( yjs.encodeStateAsUpdate( doc, decodeArray( content.stateVector ) ) ),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\trelativePositionManager.self.saveRelativePosition( doc );\n\t\t\t\t\trelativePositionManager.peers.saveRelativePositions( doc );\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonYDocTriggeredChange( listener ) {\n\t\t\tyDocTriggeredChangeListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tyDocTriggeredChangeListeners = yDocTriggeredChangeListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonConnectionReady( listener ) {\n\t\t\tconnectionReadyListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tconnectionReadyListeners = connectionReadyListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\n\t\tgetDoc() {\n\t\t\treturn doc;\n\t\t},\n\n\t\tgetPostMap() {\n\t\t\treturn doc.getMap( 'post' );\n\t\t},\n\t};\n}\n"],"mappings":"AAAA;AACA;AACA;AACA,OAAO,KAAKA,GAAZ,MAAqB,KAArB;AAEA;AACA;AACA;;AACA,SAASC,eAAT,EAA0BC,aAA1B,QAA+C,kBAA/C;AAEA;;AACA;;AACA;;AAEA,MAAMC,WAAW,GAAKC,KAAF,IAAaA,KAAK,CAACC,QAAN,EAAjC;;AACA,MAAMC,WAAW,GAAKC,MAAF,IAAc,IAAIC,UAAJ,CAAgBD,MAAM,CAACE,KAAP,CAAc,GAAd,CAAhB,CAAlC;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,OAAO,SAASC,cAAT,OAA8E;EAAA,IAArD;IAAEC,QAAF;IAAYC,uBAAZ;IAAqCC;EAArC,CAAqD;EACpF,MAAMC,GAAG,GAAG,IAAId,GAAG,CAACe,GAAR,EAAZ;EACA;;EACA,IAAIC,KAAK,GAAG,KAAZ;EAEA,IAAIC,4BAA4B,GAAG,EAAnC;EACA,IAAIC,wBAAwB,GAAG,EAA/B;EAEAJ,GAAG,CAACK,EAAJ,CAAQ,QAAR,EAAkB,CAAEC,MAAF,EAAUC,MAAV,KAAsB;IACvCT,uBAAuB,CAACU,KAAxB,CAA8BC,oBAA9B,CAAoDT,GAApD,EADuC,CAGvC;;IACA,IAAKO,MAAM,KAAKV,QAAhB,EAA2B;MAC1B,MAAMa,OAAO,GAAGvB,eAAe,CAAEa,GAAF,EAAO;QAAEW,QAAQ,EAAE;MAAZ,CAAP,CAA/B;MACAR,4BAA4B,CAACS,OAA7B,CAAwCC,QAAF,IAAgBA,QAAQ,CAAEH,OAAF,CAA9D;MACAZ,uBAAuB,CAACgB,IAAxB,CAA6BC,mBAA7B,CAAkDf,GAAlD;IACA;;IAED,MAAMgB,aAAa,GAClBT,MAAM,KAAKV,QAAX,IAAuBU,MAAM,KAAM,YAAYV,QAAU,EAAzD,IAA8DU,MAAM,YAAYrB,GAAG,CAAC+B,WADrF,CAVuC,CAavC;;IACA,IAAKD,aAAa,IAAId,KAAK,KAAK,IAAhC,EAAuC;MACtCH,WAAW,CAAE;QACZmB,QAAQ,EAAE,MADE;QAEZC,WAAW,EAAE,YAFD;QAGZb,MAAM,EAAEjB,WAAW,CAAEiB,MAAF;MAHP,CAAF,CAAX;IAKA;EACD,CArBD;;EAuBA,MAAMc,QAAQ,GAAKC,QAAF,IAAgB;IAChCnB,KAAK,GAAGmB,QAAR;;IAEA,IAAKA,QAAQ,KAAK,IAAlB,EAAyB;MACxBjB,wBAAwB,CAACQ,OAAzB,CAAoCC,QAAF,IAAgBA,QAAQ,EAA1D;IACA;EACD,CAND;;EAQA,MAAMS,IAAI,GAAG,CAAEC,WAAF,EAAeC,OAAf,KAA4B;IACxC,MAAMC,WAAW,GAAGvC,GAAG,CAACwC,iBAAJ,CAAuB1B,GAAvB,CAApB;IACAD,WAAW,CAAE;MACZmB,QAAQ,EAAE,MADE;MAEZC,WAAW,EAAE,OAFD;MAGZM,WAAW,EAAEpC,WAAW,CAAEoC,WAAF,CAHZ;MAIZlB,MAAM,EAAEV,QAJI;MAKZ0B,WALY;MAMZC;IANY,CAAF,CAAX;EAQA,CAVD;;EAYA,OAAO;IACN;AACF;AACA;AACA;AACA;AACA;IACE;IACAG,uBAAuB,CAAEC,IAAF,EAA0D;MAAA,IAAlD;QAAEC,gBAAgB,GAAG,KAArB;QAA4BC;MAA5B,CAAkD,uEAAL,EAAK;;MAChF,IAAK5B,KAAK,KAAK,IAAf,EAAsB;QACrB,MAAM,aAAN;MACA;;MAEDJ,uBAAuB,CAACU,KAAxB,CAA8BuB,qBAA9B,CAAqD/B,GAArD;MAEA,MAAMgC,iBAAiB,GAAGH,gBAAgB,GAAI,YAAYhC,QAAU,EAA1B,GAA8BA,QAAxE;MAEAG,GAAG,CAACiC,QAAJ,CAAc,MAAM;QACnB7C,aAAa,CAAEY,GAAF,EAAO4B,IAAP,EAAaE,YAAb,CAAb;MACA,CAFD,EAEGE,iBAFH;IAGA,CApBK;;IAsBNE,OAAO,GAAG;MACT,IAAKhC,KAAK,KAAK,IAAf,EAAsB;QACrB,MAAM,aAAN;MACA;;MAEDkB,QAAQ,CAAE,YAAF,CAAR;MACAE,IAAI;IACJ,CA7BK;;IA+BNa,UAAU,GAAG;MACZf,QAAQ,CAAE,KAAF,CAAR;IACA,CAjCK;;IAmCNgB,YAAY,CAAER,IAAF,EAAS;MACpB,IAAK1B,KAAK,KAAK,IAAf,EAAsB;QACrB,MAAM,aAAN;MACA;;MAEDkB,QAAQ,CAAE,IAAF,CAAR;MAEA,KAAKO,uBAAL,CAA8BC,IAA9B,EAAoC;QAAEC,gBAAgB,EAAE;MAApB,CAApC;IACA,CA3CK;;IA6CNQ,cAAc,QAAkD;MAAA,IAAhD;QAAEnB,QAAF;QAAYC,WAAZ;QAAyBZ,MAAzB;QAAiC,GAAG+B;MAApC,CAAgD;;MAC/D,IAAKpB,QAAQ,KAAK,MAAlB,EAA2B;QAC1B,MAAM,gBAAN;MACA;;MAED,QAASC,WAAT;QACC,KAAK,OAAL;UACC,IAAKmB,OAAO,CAACf,WAAR,IAAuBe,OAAO,CAACf,WAAR,KAAwB1B,QAApD,EAA+D;YAC9D;UACA;;UACDE,WAAW,CAAE;YACZmB,QAAQ,EAAE,MADE;YAEZC,WAAW,EAAE,OAFD;YAGZb,MAAM,EAAEjB,WAAW,CAAEH,GAAG,CAACqD,mBAAJ,CAAyBvC,GAAzB,EAA8BR,WAAW,CAAE8C,OAAO,CAACb,WAAV,CAAzC,CAAF,CAHP;YAIZF,WAAW,EAAEhB;UAJD,CAAF,CAAX;;UAMA,IAAK,CAAE+B,OAAO,CAACd,OAAf,EAAyB;YACxBF,IAAI,CAAEf,MAAF,EAAU,IAAV,CAAJ;UACA;;UACD;;QACD,KAAK,OAAL;UACC,IAAK+B,OAAO,CAACf,WAAR,KAAwB1B,QAA7B,EAAwC;YACvC;UACA;;UACDX,GAAG,CAACsD,WAAJ,CAAiBxC,GAAjB,EAAsBR,WAAW,CAAE8C,OAAO,CAAChC,MAAV,CAAjC,EAAqDC,MAArD;UACAa,QAAQ,CAAE,IAAF,CAAR;UACA;;QACD,KAAK,YAAL;UACCtB,uBAAuB,CAACgB,IAAxB,CAA6B2B,oBAA7B,CAAmDzC,GAAnD;UACAF,uBAAuB,CAACU,KAAxB,CAA8BuB,qBAA9B,CAAqD/B,GAArD;UACAd,GAAG,CAACsD,WAAJ,CAAiBxC,GAAjB,EAAsBR,WAAW,CAAE8C,OAAO,CAAChC,MAAV,CAAjC,EAAqDC,MAArD;UACA;MA1BF;IA4BA,CA9EK;;IAgFNmC,qBAAqB,CAAE7B,QAAF,EAAa;MACjCV,4BAA4B,CAACwC,IAA7B,CAAmC9B,QAAnC;MAEA,OAAO,MAAM;QACZV,4BAA4B,GAAGA,4BAA4B,CAACyC,MAA7B,CAAuCC,CAAF,IAASA,CAAC,KAAKhC,QAApD,CAA/B;MACA,CAFD;IAGA,CAtFK;;IAwFNiC,iBAAiB,CAAEjC,QAAF,EAAa;MAC7BT,wBAAwB,CAACuC,IAAzB,CAA+B9B,QAA/B;MAEA,OAAO,MAAM;QACZT,wBAAwB,GAAGA,wBAAwB,CAACwC,MAAzB,CAAmCC,CAAF,IAASA,CAAC,KAAKhC,QAAhD,CAA3B;MACA,CAFD;IAGA,CA9FK;;IAgGNkC,QAAQ,GAAG;MACV,OAAO7C,KAAP;IACA,CAlGK;;IAoGN8C,MAAM,GAAG;MACR,OAAOhD,GAAP;IACA,CAtGK;;IAwGNiD,UAAU,GAAG;MACZ,OAAOjD,GAAG,CAACkD,MAAJ,CAAY,MAAZ,CAAP;IACA;;EA1GK,CAAP;AA4GA"}