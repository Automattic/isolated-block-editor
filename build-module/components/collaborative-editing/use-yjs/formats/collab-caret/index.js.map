{"version":3,"sources":["../../../../../../src/components/collaborative-editing/use-yjs/formats/collab-caret/index.js"],"names":["memoize","classnames","applyFormat","registerFormatType","shouldUseWhiteText","FORMAT_NAME","applyCarets","record","carets","forEach","caret","start","end","id","color","label","isCollapsed","isShifted","text","length","lastGrapheme","Intl","Segmenter","segment","pop","undefined","offset","type","attributes","class","title","style","join","getCarets","peers","richTextIdentifier","blockClientId","Object","entries","filter","peer","clientId","attributeKey","map","name","settings","tagName","className","edit","__experimentalGetPropsForEditableTreePreparation","select","getCollabPeers","__experimentalCreatePrepareEditableTree","formats","registerFormatCollabCaret"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport memoize from 'memize';\nimport classnames from 'classnames';\n\n/**\n * WordPress dependencies\n */\nimport { applyFormat, registerFormatType } from '@wordpress/rich-text';\n\n/**\n * Internal dependencies\n */\nimport { shouldUseWhiteText } from './color-utils';\nimport './style.scss';\n\nexport const FORMAT_NAME = 'isolated/collab-caret';\n\n/**\n * Applies given carets to the given record.\n *\n * @param {Object} record The record to apply carets to.\n * @param {Array} carets The carets to apply.\n * @return {Object} A record with the carets applied.\n */\nexport function applyCarets( record, carets = [] ) {\n\tcarets.forEach( ( caret ) => {\n\t\tlet { start, end, id, color, label } = caret;\n\t\tconst isCollapsed = start === end;\n\t\tconst isShifted = isCollapsed && end >= record.text.length;\n\n\t\t// Try to accurately get the `length` of the last character (i.e. grapheme) in case\n\t\t// the last character is an emoji, where \"<emoji>\".length can be more than 1.\n\t\t// For example, \"ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦\".length === 11. (Intl.Segementer is still unsupported in Firefox)\n\t\t// @ts-ignore Intl.Segmenter is not in spec yet\n\t\tconst lastGrapheme = Intl.Segmenter\n\t\t\t? // @ts-ignore Intl.Segmenter is not in spec yet\n\t\t\t  [ ...new Intl.Segmenter().segment( record.text ) ].pop()?.segment\n\t\t\t: undefined;\n\t\tconst offset = lastGrapheme?.length ?? 1; // fall back to 1 if we can't accurately segment the last grapheme\n\n\t\tif ( isShifted ) {\n\t\t\tstart = record.text.length - offset;\n\t\t}\n\n\t\tif ( isCollapsed ) {\n\t\t\tend = start + offset;\n\t\t}\n\n\t\trecord = applyFormat(\n\t\t\trecord,\n\t\t\t{\n\t\t\t\ttype: FORMAT_NAME,\n\t\t\t\tattributes: {\n\t\t\t\t\tid: 'iso-editor-collab-caret-' + id,\n\t\t\t\t\tclass: classnames( {\n\t\t\t\t\t\t'is-collapsed': isCollapsed,\n\t\t\t\t\t\t'is-shifted': isShifted,\n\t\t\t\t\t} ),\n\t\t\t\t\ttitle: label,\n\t\t\t\t\tstyle: [\n\t\t\t\t\t\t`--iso-editor-collab-caret-color: ${ color || '#2e3d48' };`,\n\t\t\t\t\t\t`--iso-editor-collab-caret-label-text-color: ${\n\t\t\t\t\t\t\tshouldUseWhiteText( color ) ? '#fff' : '#1e1e1e'\n\t\t\t\t\t\t};`,\n\t\t\t\t\t].join( ' ' ),\n\t\t\t\t},\n\t\t\t},\n\t\t\tstart,\n\t\t\tend\n\t\t);\n\t} );\n\n\treturn record;\n}\n\nconst getCarets = memoize( ( peers, richTextIdentifier, blockClientId ) => {\n\treturn Object.entries( peers )\n\t\t.filter( ( [ , peer ] ) => {\n\t\t\treturn (\n\t\t\t\tpeer?.start?.clientId === blockClientId &&\n\t\t\t\tpeer?.end?.clientId === blockClientId &&\n\t\t\t\tpeer.start.attributeKey === richTextIdentifier\n\t\t\t);\n\t\t} )\n\t\t.map( ( [ id, peer ] ) => ( {\n\t\t\tid,\n\t\t\tlabel: peer.name,\n\t\t\tstart: peer.start.offset,\n\t\t\tend: peer.end.offset,\n\t\t\tcolor: peer.color,\n\t\t} ) );\n} );\n\nexport const settings = {\n\ttitle: 'Collaboration peer caret',\n\ttagName: 'mark',\n\tclassName: 'iso-editor-collab-caret',\n\tattributes: {\n\t\tid: 'id',\n\t\tclassName: 'class',\n\t},\n\tedit() {\n\t\treturn null;\n\t},\n\t__experimentalGetPropsForEditableTreePreparation( select, { richTextIdentifier, blockClientId } ) {\n\t\treturn {\n\t\t\tcarets: getCarets( select( 'isolated/editor' ).getCollabPeers(), richTextIdentifier, blockClientId ),\n\t\t};\n\t},\n\t__experimentalCreatePrepareEditableTree( { carets } ) {\n\t\treturn ( formats, text ) => {\n\t\t\tif ( ! carets?.length ) {\n\t\t\t\treturn formats;\n\t\t\t}\n\n\t\t\tlet record = { formats, text };\n\t\t\trecord = applyCarets( record, carets );\n\t\t\treturn record.formats;\n\t\t};\n\t},\n};\n\nexport const registerFormatCollabCaret = () => {\n\tregisterFormatType( FORMAT_NAME, settings );\n};\n"],"file":"index.js"}