{"version":3,"file":"index.js","names":["useEffect","useDispatch","useSelect","store","blocksStore","getEditorSettings","useEditorSetup","settings","_currentSettings$edit","undo","setupEditor","updateEditorSettings","setupEditorState","setupCoreEditor","updateSettings","isEditing","topToolbar","currentSettings","select","_settings$iso","_settings$iso$default","_settings$iso2","_settings$iso2$defaul","isEditingSelect","isFeatureActive","getBlockTypes","blockTypes","hasFixedToolbar","editor","iso","defaultPreferences","fixedToolbar","undefined","__experimentalReusableBlocks","__experimentalFetchReusableBlocks","__experimentalUndo","updateAllSettings","newSettings","window","__editorAssets","styles","scripts","id","type","reusableBlocks"],"sources":["../../../src/components/editor-setup/index.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\n\nimport { useEffect } from '@wordpress/element';\nimport { useDispatch, useSelect } from '@wordpress/data';\nimport { store as blocksStore } from '@wordpress/blocks';\n\n/**\n * Internal dependencies\n */\n\nimport getEditorSettings from './editor-settings';\n\n/** @typedef {import('../../index').BlockEditorSettings} BlockEditorSettings */\n\n/**\n * Settings callback\n *\n * @callback OnSettings\n * @param {BlockEditorSettings} settings\n */\n\n/**\n * Sets up Gutenberg and the Isolated Block Editor\n *\n * An initial setup is performed, and is then reset each time the editor is focussed. This ensures we are applying the right\n * settings for this particular editor.\n *\n * @param {BlockEditorSettings} settings - Settings\n */\nexport default function useEditorSetup( settings ) {\n\t// @ts-ignore\n\tconst { undo, setupEditor } = useDispatch( 'isolated/editor' );\n\tconst { updateEditorSettings, setupEditorState: setupCoreEditor } = useDispatch( 'core/editor' );\n\tconst { updateSettings } = useDispatch( 'core/block-editor' );\n\tconst { isEditing, topToolbar, currentSettings } = useSelect( ( select ) => {\n\t\tconst { isEditing: isEditingSelect, isFeatureActive } = select( 'isolated/editor' );\n\t\t// @ts-ignore\n\t\tconst { getBlockTypes } = select( blocksStore );\n\t\tconst blockTypes = getBlockTypes();\n\t\t// @ts-ignore\n\t\tconst hasFixedToolbar = isFeatureActive( 'fixedToolbar' );\n\n\t\treturn {\n\t\t\t// @ts-ignore\n\t\t\tisEditing: isEditingSelect(),\n\t\t\ttopToolbar: hasFixedToolbar,\n\t\t\tcurrentSettings: {\n\t\t\t\t...settings,\n\n\t\t\t\teditor: {\n\t\t\t\t\t...getEditorSettings(\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tsettings.editor,\n\t\t\t\t\t\tsettings.iso,\n\t\t\t\t\t\tblockTypes,\n\t\t\t\t\t\t// Use the default preference, if set, otherwise use the feature\n\t\t\t\t\t\tsettings.iso?.defaultPreferences?.fixedToolbar !== undefined\n\t\t\t\t\t\t\t? settings.iso?.defaultPreferences?.fixedToolbar\n\t\t\t\t\t\t\t: hasFixedToolbar\n\t\t\t\t\t),\n\n\t\t\t\t\t// Reusable blocks\n\t\t\t\t\t__experimentalReusableBlocks: [],\n\t\t\t\t\t__experimentalFetchReusableBlocks: false,\n\n\t\t\t\t\t// Experimental undo, to do some experimental things\n\t\t\t\t\t__experimentalUndo: undo\n\t\t\t\t},\n\t\t\t}\n\t\t};\n\t}, [ settings ] );\n\n\tfunction updateAllSettings( newSettings ) {\n\t\tupdateSettings( newSettings.editor );\n\t\tupdateEditorSettings( newSettings.editor );\n\t}\n\n\t// This is the initial setup\n\tuseEffect( () => {\n\t\t// Ensure we always have a __editorAssets value - Gutenberg hardcoded assets\n\t\t// @ts-ignore\n\t\tif ( window.__editorAssets === undefined ) {\n\t\t\t// @ts-ignore\n\t\t\twindow.__editorAssets = { styles: '', scripts: '' };\n\t\t}\n\n\t\t// Setup the Isolated Editor & Gutenberg\n\t\tsetupEditor( currentSettings );\n\n\t\t// And Gutenberg\n\t\tupdateAllSettings( currentSettings );\n\n\t\t// Set up the post entities with some dummy data, ensuring that anything that uses post entities can work\n\t\tsetupCoreEditor(\n\t\t\t{\n\t\t\t\tid: 0,\n\t\t\t\ttype: 'post',\n\t\t\t},\n\t\t\t[]\n\t\t);\n\t}, [] );\n\n\t// Run whenever the editor is focussed, or the topToolbar setting or reusable blocks change\n\tuseEffect( () => {\n\t\tif ( !isEditing ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Setup Gutenberg for this editor, but only when focussed. This swaps allowed blocks and other capabilities\n\t\tupdateSettings( currentSettings );\n\t}, [ isEditing, topToolbar, currentSettings?.editor?.reusableBlocks ] );\n\n\treturn settings;\n}\n"],"mappings":"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"}