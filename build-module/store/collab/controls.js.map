{"version":3,"file":"controls.js","names":["ActionCreators","createRegistryControl","debugUndo","require","getRichTextHint","registry","clientId","attributeKey","select","getSelectionStart","undefined","applyChangesToYDoc","action","doc","getYDoc","isTriggeredByYDoc","applyLocalChangesToYDoc","blocks","isInitialContent","richTextHint","UPDATE_BLOCKS_WITH_UNDO","UPDATE_BLOCKS_WITHOUT_UNDO","undo","type","undoManager","getUndoManager","redo"],"sources":["../../../src/store/collab/controls.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { ActionCreators } from 'redux-undo';\n\n/**\n * WordPress dependencies\n */\nimport { createRegistryControl } from '@wordpress/data';\n\nconst debugUndo = require( 'debug' )( 'iso-editor:collab:undo' );\n\n// TODO: Unsolved problem\n/**\n * Return the clientId and block attribute key if the current selection can be\n * associated with a RichText attribute.\n *\n * Caution: This won't return false positives, but it will return false negatives.\n * Currently the only way of telling whether a given block attribute is associated with a `<RichText>`\n * in the editor is for it to be passed an `identifier` prop with the block attribute key,\n * e.g. `<RichText identifier=\"myAttributeKey\" />`. If the block developer has neglected to do this,\n * the selection.attributeKey will fall back to a `number`, and we can't tell which attribute it's\n * actually associated with. This happens a lot because the `identifier` prop is undocumented.\n *\n * @param registry\n * @return {import('../../components/collaborative-editing').RichTextHint|undefined}\n */\nconst getRichTextHint = ( registry ) => {\n\tconst { clientId, attributeKey } = registry.select( 'core/block-editor' ).getSelectionStart();\n\n\t// If the selection has an attribute key that is a string, we can deduce that the attribute is a RichText\n\treturn typeof attributeKey === 'string' ? { clientId, attributeKey } : undefined;\n};\n\nconst applyChangesToYDoc = createRegistryControl( ( registry ) => ( action ) => {\n\tconst doc = registry.select( 'isolated/editor' ).getYDoc();\n\n\t// If the change is triggered locally from the editor (i.e. is neither a remote change nor an undo/redo),\n\t// apply those changes to the Yjs doc.\n\tif ( doc && ! action.isTriggeredByYDoc ) {\n\t\tdoc.applyLocalChangesToYDoc(\n\t\t\t{ blocks: action.blocks },\n\t\t\t{\n\t\t\t\tisInitialContent: action.isInitialContent,\n\t\t\t\trichTextHint: getRichTextHint( registry ),\n\t\t\t}\n\t\t);\n\t}\n\n\treturn action;\n} );\n\nexport default {\n\tUPDATE_BLOCKS_WITH_UNDO: applyChangesToYDoc,\n\tUPDATE_BLOCKS_WITHOUT_UNDO: applyChangesToYDoc,\n\n\t[ ActionCreators.undo().type ]: createRegistryControl( ( registry ) => ( action ) => {\n\t\tconst undoManager = registry.select( 'isolated/editor' ).getUndoManager();\n\n\t\tif ( ! undoManager ) {\n\t\t\tdebugUndo( 'Undoing from redux-undo state' );\n\t\t\treturn action;\n\t\t}\n\t\tdebugUndo( 'Undoing from yjs undoManager' );\n\n\t\tdebugUndo( 'undo' );\n\t\tundoManager.undo();\n\t\treturn undefined; // prevent default action\n\t} ),\n\n\t[ ActionCreators.redo().type ]: createRegistryControl( ( registry ) => ( action ) => {\n\t\tconst undoManager = registry.select( 'isolated/editor' ).getUndoManager();\n\n\t\tif ( ! undoManager ) {\n\t\t\treturn action;\n\t\t}\n\n\t\tdebugUndo( 'redo' );\n\t\tregistry.select( 'isolated/editor' ).getUndoManager().redo();\n\t\treturn undefined; // prevent default action\n\t} ),\n};\n"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,cAAT,QAA+B,YAA/B;AAEA;AACA;AACA;;AACA,SAASC,qBAAT,QAAsC,iBAAtC;;AAEA,MAAMC,SAAS,GAAGC,OAAO,CAAE,OAAF,CAAP,CAAoB,wBAApB,CAAlB,C,CAEA;;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,MAAMC,eAAe,GAAKC,QAAF,IAAgB;EACvC,MAAM;IAAEC,QAAF;IAAYC;EAAZ,IAA6BF,QAAQ,CAACG,MAAT,CAAiB,mBAAjB,EAAuCC,iBAAvC,EAAnC,CADuC,CAGvC;;EACA,OAAO,OAAOF,YAAP,KAAwB,QAAxB,GAAmC;IAAED,QAAF;IAAYC;EAAZ,CAAnC,GAAgEG,SAAvE;AACA,CALD;;AAOA,MAAMC,kBAAkB,GAAGV,qBAAqB,CAAII,QAAF,IAAkBO,MAAF,IAAc;EAC/E,MAAMC,GAAG,GAAGR,QAAQ,CAACG,MAAT,CAAiB,iBAAjB,EAAqCM,OAArC,EAAZ,CAD+E,CAG/E;EACA;;EACA,IAAKD,GAAG,IAAI,CAAED,MAAM,CAACG,iBAArB,EAAyC;IACxCF,GAAG,CAACG,uBAAJ,CACC;MAAEC,MAAM,EAAEL,MAAM,CAACK;IAAjB,CADD,EAEC;MACCC,gBAAgB,EAAEN,MAAM,CAACM,gBAD1B;MAECC,YAAY,EAAEf,eAAe,CAAEC,QAAF;IAF9B,CAFD;EAOA;;EAED,OAAOO,MAAP;AACA,CAhB+C,CAAhD;AAkBA,eAAe;EACdQ,uBAAuB,EAAET,kBADX;EAEdU,0BAA0B,EAAEV,kBAFd;EAId,CAAEX,cAAc,CAACsB,IAAf,GAAsBC,IAAxB,GAAgCtB,qBAAqB,CAAII,QAAF,IAAkBO,MAAF,IAAc;IACpF,MAAMY,WAAW,GAAGnB,QAAQ,CAACG,MAAT,CAAiB,iBAAjB,EAAqCiB,cAArC,EAApB;;IAEA,IAAK,CAAED,WAAP,EAAqB;MACpBtB,SAAS,CAAE,+BAAF,CAAT;MACA,OAAOU,MAAP;IACA;;IACDV,SAAS,CAAE,8BAAF,CAAT;IAEAA,SAAS,CAAE,MAAF,CAAT;IACAsB,WAAW,CAACF,IAAZ;IACA,OAAOZ,SAAP,CAXoF,CAWlE;EAClB,CAZoD,CAJvC;EAkBd,CAAEV,cAAc,CAAC0B,IAAf,GAAsBH,IAAxB,GAAgCtB,qBAAqB,CAAII,QAAF,IAAkBO,MAAF,IAAc;IACpF,MAAMY,WAAW,GAAGnB,QAAQ,CAACG,MAAT,CAAiB,iBAAjB,EAAqCiB,cAArC,EAApB;;IAEA,IAAK,CAAED,WAAP,EAAqB;MACpB,OAAOZ,MAAP;IACA;;IAEDV,SAAS,CAAE,MAAF,CAAT;IACAG,QAAQ,CAACG,MAAT,CAAiB,iBAAjB,EAAqCiB,cAArC,GAAsDC,IAAtD;IACA,OAAOhB,SAAP,CAToF,CASlE;EAClB,CAVoD;AAlBvC,CAAf"}