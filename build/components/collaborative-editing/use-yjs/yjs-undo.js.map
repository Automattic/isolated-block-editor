{"version":3,"file":"yjs-undo.js","names":["yjs","_interopRequireWildcard","require","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","debugUndo","setupUndoManager","typeScope","identity","registry","dispatch","select","getSelection","start","getSelectionStart","end","getSelectionEnd","setSelection","_ref","selectionChange","clientId","attributeKey","offset","undoManager","UndoManager","trackedOrigins","Set","debugUndoWithStackSizes","apply","arguments","concat","undoStack","length","redoStack","on","event","selection","stackItem","meta","type","setUndoManager"],"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-undo.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\nconst debugUndo = require( 'debug' )( 'iso-editor:collab:undo' );\n\n/**\n * Set up undo handling.\n *\n * @param {yjs.AbstractType} typeScope - Yjs type to initialize the undo manager with.\n * @param {string} identity\n * @param {Object} registry - Registry object from `@wordpress/data`.\n */\nexport function setupUndoManager( typeScope, identity, registry ) {\n\tconst { dispatch, select } = registry;\n\n\tconst getSelection = () => ( {\n\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t} );\n\tconst setSelection = ( { start, end } ) =>\n\t\tdispatch( 'core/block-editor' ).selectionChange(\n\t\t\tstart?.clientId,\n\t\t\tstart?.attributeKey,\n\t\t\tstart?.offset,\n\t\t\tend?.offset\n\t\t);\n\n\tconst undoManager = new yjs.UndoManager( typeScope, { trackedOrigins: new Set( [ identity ] ) } );\n\n\tconst debugUndoWithStackSizes = ( ...args ) => {\n\t\tdebugUndo( ...args );\n\t\tdebugUndo( `stack size: undo ${ undoManager.undoStack.length }, redo ${ undoManager.redoStack.length }` );\n\t};\n\n\tundoManager.on( 'stack-item-added', ( event ) => {\n\t\tconst selection = getSelection();\n\t\tevent.stackItem.meta.set( 'caret-location', selection );\n\t\tdebugUndoWithStackSizes( `${ event.type } stack item added with selection`, selection );\n\t} );\n\n\tundoManager.on( 'stack-item-popped', ( event ) => {\n\t\tif ( event.type === 'undo' && undoManager.undoStack.length === 0 ) {\n\t\t\tdebugUndoWithStackSizes( `undo stack item popped (last item, no caret position to restore)` );\n\t\t\treturn;\n\t\t}\n\n\t\tconst selection = event.stackItem.meta.get( 'caret-location' );\n\n\t\tif ( selection?.start ) {\n\t\t\tsetSelection( selection );\n\t\t\tdebugUndoWithStackSizes( `${ event.type } stack item popped with selection`, selection );\n\t\t\treturn;\n\t\t}\n\n\t\tdebugUndoWithStackSizes( `${ event.type } stack item popped without selection` );\n\t} );\n\n\tdispatch( 'isolated/editor' ).setUndoManager( undoManager );\n\n\tdebugUndo( 'instantiated UndoManager' );\n}\n"],"mappings":"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"}