{"version":3,"file":"relative-position.js","names":["RelativePosition","getSelection","selectionChange","doc","start","end","clientId","attributeKey","richTexts","getMap","get","has","offset","xmlText","relPos","startOffset","yjs","createRelativePositionFromTypeIndex","endOffset","undefined","absStartOffset","createAbsolutePositionFromRelativePosition","index","absEndOffset","PeerRelativePosition","getPeers","setPeerSelection","_getPeers","_setPeerSelection","peerId","peer","_peerRelativePositions","Object","entries","map","_initRelativePositionForPeer","forEach","saveRelativePosition","setAbsolutePosition"],"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/relative-position.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * @typedef WPBlockSelection\n * @property {string} [clientId]\n * @property {string} [attributeKey]\n * @property {number} [offset]\n */\n\n/**\n * @typedef SelectionRange\n * @property {WPBlockSelection} start\n * @property {WPBlockSelection} end\n */\n\n/**\n * @typedef RelativePositionManager\n * @property {RelativePosition} self\n * @property {PeerRelativePosition} peers\n */\n\n/**\n * Handle the conversion between a Yjs relative position and a Gutenberg absolute position.\n *\n * This is used to maintain a user's caret position so it doesn't look like it's pushed around by remote changes.\n * For example, if my caret is at `ab|c` and a remote user changes the text to `aabc`, I want my\n * caret to \"stay\" relative to the `b` (`aab|c`) instead of staying at the same absolute index (`aa|bc`).\n */\nexport class RelativePosition {\n\t/**\n\t * @param {() => SelectionRange} getSelection - Function to get block editor selection.\n\t * @param {(clientId: string, attributeKey: string, startOffset: number, endOffset: number) => void} selectionChange - Function to set block editor selection.\n\t */\n\tconstructor( getSelection, selectionChange ) {\n\t\tthis.getSelection = getSelection;\n\t\tthis.selectionChange = selectionChange;\n\t}\n\n\t/**\n\t * Get the current block editor selection, convert it to a Y.RelativePosition, and remember it.\n\t *\n\t * Call this method _before_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePosition( doc ) {\n\t\tconst { start, end } = this.getSelection();\n\t\tconst { clientId, attributeKey } = start ?? {};\n\t\tconst richTexts = doc.getMap( 'post' )?.get( 'blocks' )?.get( 'richTexts' );\n\n\t\tif (\n\t\t\trichTexts?.get( clientId )?.has( attributeKey ) &&\n\t\t\ttypeof start.offset === 'number' &&\n\t\t\ttypeof end.offset === 'number'\n\t\t) {\n\t\t\tconst xmlText = richTexts.get( clientId ).get( attributeKey ).get( 'xmlText' );\n\t\t\tthis.relPos = {\n\t\t\t\tclientId,\n\t\t\t\tattributeKey,\n\t\t\t\tstartOffset: yjs.createRelativePositionFromTypeIndex( xmlText, start.offset, -1 ),\n\t\t\t\tendOffset: yjs.createRelativePositionFromTypeIndex( xmlText, end.offset, -1 ),\n\t\t\t};\n\t\t} else {\n\t\t\tthis.relPos = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * If a saved Y.RelativePosition exists, convert it to an absolute position and\n\t * dispatch it as a selection change to the block editor.\n\t *\n\t * Call this method _after_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePosition( doc ) {\n\t\tif ( ! this.relPos?.clientId || ! this.relPos?.attributeKey ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { clientId, attributeKey, startOffset, endOffset } = this.relPos;\n\t\tconst absStartOffset = yjs.createAbsolutePositionFromRelativePosition( startOffset, doc )?.index;\n\t\tconst absEndOffset = yjs.createAbsolutePositionFromRelativePosition( endOffset, doc )?.index;\n\n\t\tif ( typeof absStartOffset !== 'number' || typeof absEndOffset !== 'number' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectionChange( clientId, attributeKey, absStartOffset, absEndOffset );\n\t}\n}\n\nexport class PeerRelativePosition {\n\t/**\n\t * @private\n\t * @type {RelativePosition[]}\n\t */\n\t_peerRelativePositions = [];\n\n\t/**\n\t * @param {() => Record<string, Partial<SelectionRange>>} getPeers\n\t * @param {(peerId: string, selection: SelectionRange) => void} setPeerSelection\n\t */\n\tconstructor( getPeers, setPeerSelection ) {\n\t\t/** @private */\n\t\tthis._getPeers = getPeers;\n\t\t/** @private */\n\t\tthis._setPeerSelection = setPeerSelection;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} peerId\n\t * @param {Partial<SelectionRange>} peer\n\t * @return {RelativePosition}\n\t */\n\t_initRelativePositionForPeer( peerId, peer ) {\n\t\treturn new RelativePosition(\n\t\t\t() => ( { start: peer.start ?? {}, end: peer.end ?? {} } ),\n\t\t\t( clientId, attributeKey, startOffset, endOffset ) =>\n\t\t\t\tthis._setPeerSelection( peerId, {\n\t\t\t\t\tstart: { clientId, attributeKey, offset: startOffset },\n\t\t\t\t\tend: { clientId, attributeKey, offset: endOffset },\n\t\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePositions( doc ) {\n\t\tthis._peerRelativePositions = Object.entries( this._getPeers() ).map( ( [ peerId, peer ] ) =>\n\t\t\tthis._initRelativePositionForPeer( peerId, peer )\n\t\t);\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.saveRelativePosition( doc ) );\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePositions( doc ) {\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.setAbsolutePosition( doc ) );\n\t}\n}\n"],"mappings":"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"}