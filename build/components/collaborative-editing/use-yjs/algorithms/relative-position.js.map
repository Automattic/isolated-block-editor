{"version":3,"file":"relative-position.js","names":["yjs","_interopRequireWildcard","require","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","RelativePosition","getSelection","selectionChange","_classCallCheck2","_createClass2","value","saveRelativePosition","doc","_doc$getMap","_doc$getMap$get","_richTexts$get","_this$getSelection","start","end","_ref","clientId","attributeKey","richTexts","getMap","offset","xmlText","relPos","startOffset","createRelativePositionFromTypeIndex","endOffset","undefined","setAbsolutePosition","_this$relPos","_this$relPos2","_yjs$createAbsolutePo","_yjs$createAbsolutePo2","_this$relPos3","absStartOffset","createAbsolutePositionFromRelativePosition","index","absEndOffset","exports","PeerRelativePosition","getPeers","setPeerSelection","_defineProperty2","_getPeers","_setPeerSelection","_initRelativePositionForPeer","peerId","peer","_this","_peer$start","_peer$end","saveRelativePositions","_this2","_peerRelativePositions","entries","map","_ref2","_ref3","_slicedToArray2","forEach","setAbsolutePositions"],"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/relative-position.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * @typedef WPBlockSelection\n * @property {string} [clientId]\n * @property {string} [attributeKey]\n * @property {number} [offset]\n */\n\n/**\n * @typedef SelectionRange\n * @property {WPBlockSelection} start\n * @property {WPBlockSelection} end\n */\n\n/**\n * @typedef RelativePositionManager\n * @property {RelativePosition} self\n * @property {PeerRelativePosition} peers\n */\n\n/**\n * Handle the conversion between a Yjs relative position and a Gutenberg absolute position.\n *\n * This is used to maintain a user's caret position so it doesn't look like it's pushed around by remote changes.\n * For example, if my caret is at `ab|c` and a remote user changes the text to `aabc`, I want my\n * caret to \"stay\" relative to the `b` (`aab|c`) instead of staying at the same absolute index (`aa|bc`).\n */\nexport class RelativePosition {\n\t/**\n\t * @param {() => SelectionRange} getSelection - Function to get block editor selection.\n\t * @param {(clientId: string, attributeKey: string, startOffset: number, endOffset: number) => void} selectionChange - Function to set block editor selection.\n\t */\n\tconstructor( getSelection, selectionChange ) {\n\t\tthis.getSelection = getSelection;\n\t\tthis.selectionChange = selectionChange;\n\t}\n\n\t/**\n\t * Get the current block editor selection, convert it to a Y.RelativePosition, and remember it.\n\t *\n\t * Call this method _before_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePosition( doc ) {\n\t\tconst { start, end } = this.getSelection();\n\t\tconst { clientId, attributeKey } = start ?? {};\n\t\tconst richTexts = doc.getMap( 'post' )?.get( 'blocks' )?.get( 'richTexts' );\n\n\t\tif (\n\t\t\trichTexts?.get( clientId )?.has( attributeKey ) &&\n\t\t\ttypeof start.offset === 'number' &&\n\t\t\ttypeof end.offset === 'number'\n\t\t) {\n\t\t\tconst xmlText = richTexts.get( clientId ).get( attributeKey ).get( 'xmlText' );\n\t\t\tthis.relPos = {\n\t\t\t\tclientId,\n\t\t\t\tattributeKey,\n\t\t\t\tstartOffset: yjs.createRelativePositionFromTypeIndex( xmlText, start.offset, -1 ),\n\t\t\t\tendOffset: yjs.createRelativePositionFromTypeIndex( xmlText, end.offset, -1 ),\n\t\t\t};\n\t\t} else {\n\t\t\tthis.relPos = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * If a saved Y.RelativePosition exists, convert it to an absolute position and\n\t * dispatch it as a selection change to the block editor.\n\t *\n\t * Call this method _after_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePosition( doc ) {\n\t\tif ( ! this.relPos?.clientId || ! this.relPos?.attributeKey ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { clientId, attributeKey, startOffset, endOffset } = this.relPos;\n\t\tconst absStartOffset = yjs.createAbsolutePositionFromRelativePosition( startOffset, doc )?.index;\n\t\tconst absEndOffset = yjs.createAbsolutePositionFromRelativePosition( endOffset, doc )?.index;\n\n\t\tif ( typeof absStartOffset !== 'number' || typeof absEndOffset !== 'number' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectionChange( clientId, attributeKey, absStartOffset, absEndOffset );\n\t}\n}\n\nexport class PeerRelativePosition {\n\t/**\n\t * @private\n\t * @type {RelativePosition[]}\n\t */\n\t_peerRelativePositions = [];\n\n\t/**\n\t * @param {() => Record<string, Partial<SelectionRange>>} getPeers\n\t * @param {(peerId: string, selection: SelectionRange) => void} setPeerSelection\n\t */\n\tconstructor( getPeers, setPeerSelection ) {\n\t\t/** @private */\n\t\tthis._getPeers = getPeers;\n\t\t/** @private */\n\t\tthis._setPeerSelection = setPeerSelection;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} peerId\n\t * @param {Partial<SelectionRange>} peer\n\t * @return {RelativePosition}\n\t */\n\t_initRelativePositionForPeer( peerId, peer ) {\n\t\treturn new RelativePosition(\n\t\t\t() => ( { start: peer.start ?? {}, end: peer.end ?? {} } ),\n\t\t\t( clientId, attributeKey, startOffset, endOffset ) =>\n\t\t\t\tthis._setPeerSelection( peerId, {\n\t\t\t\t\tstart: { clientId, attributeKey, offset: startOffset },\n\t\t\t\t\tend: { clientId, attributeKey, offset: endOffset },\n\t\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePositions( doc ) {\n\t\tthis._peerRelativePositions = Object.entries( this._getPeers() ).map( ( [ peerId, peer ] ) =>\n\t\t\tthis._initRelativePositionForPeer( peerId, peer )\n\t\t);\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.saveRelativePosition( doc ) );\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePositions( doc ) {\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.setAbsolutePosition( doc ) );\n\t}\n}\n"],"mappings":"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"}