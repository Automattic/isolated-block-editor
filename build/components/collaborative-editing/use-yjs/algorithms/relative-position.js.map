{"version":3,"file":"relative-position.js","names":["RelativePosition","getSelection","selectionChange","doc","start","end","clientId","attributeKey","richTexts","getMap","get","has","offset","xmlText","relPos","startOffset","yjs","createRelativePositionFromTypeIndex","endOffset","undefined","absStartOffset","createAbsolutePositionFromRelativePosition","index","absEndOffset","PeerRelativePosition","getPeers","setPeerSelection","_getPeers","_setPeerSelection","peerId","peer","_peerRelativePositions","Object","entries","map","_initRelativePositionForPeer","forEach","saveRelativePosition","setAbsolutePosition"],"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/relative-position.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * @typedef WPBlockSelection\n * @property {string} [clientId]\n * @property {string} [attributeKey]\n * @property {number} [offset]\n */\n\n/**\n * @typedef SelectionRange\n * @property {WPBlockSelection} start\n * @property {WPBlockSelection} end\n */\n\n/**\n * @typedef RelativePositionManager\n * @property {RelativePosition} self\n * @property {PeerRelativePosition} peers\n */\n\n/**\n * Handle the conversion between a Yjs relative position and a Gutenberg absolute position.\n *\n * This is used to maintain a user's caret position so it doesn't look like it's pushed around by remote changes.\n * For example, if my caret is at `ab|c` and a remote user changes the text to `aabc`, I want my\n * caret to \"stay\" relative to the `b` (`aab|c`) instead of staying at the same absolute index (`aa|bc`).\n */\nexport class RelativePosition {\n\t/**\n\t * @param {() => SelectionRange} getSelection - Function to get block editor selection.\n\t * @param {(clientId: string, attributeKey: string, startOffset: number, endOffset: number) => void} selectionChange - Function to set block editor selection.\n\t */\n\tconstructor( getSelection, selectionChange ) {\n\t\tthis.getSelection = getSelection;\n\t\tthis.selectionChange = selectionChange;\n\t}\n\n\t/**\n\t * Get the current block editor selection, convert it to a Y.RelativePosition, and remember it.\n\t *\n\t * Call this method _before_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePosition( doc ) {\n\t\tconst { start, end } = this.getSelection();\n\t\tconst { clientId, attributeKey } = start ?? {};\n\t\tconst richTexts = doc.getMap( 'post' )?.get( 'blocks' )?.get( 'richTexts' );\n\n\t\tif (\n\t\t\trichTexts?.get( clientId )?.has( attributeKey ) &&\n\t\t\ttypeof start.offset === 'number' &&\n\t\t\ttypeof end.offset === 'number'\n\t\t) {\n\t\t\tconst xmlText = richTexts.get( clientId ).get( attributeKey ).get( 'xmlText' );\n\t\t\tthis.relPos = {\n\t\t\t\tclientId,\n\t\t\t\tattributeKey,\n\t\t\t\tstartOffset: yjs.createRelativePositionFromTypeIndex( xmlText, start.offset, -1 ),\n\t\t\t\tendOffset: yjs.createRelativePositionFromTypeIndex( xmlText, end.offset, -1 ),\n\t\t\t};\n\t\t} else {\n\t\t\tthis.relPos = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * If a saved Y.RelativePosition exists, convert it to an absolute position and\n\t * dispatch it as a selection change to the block editor.\n\t *\n\t * Call this method _after_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePosition( doc ) {\n\t\tif ( ! this.relPos?.clientId || ! this.relPos?.attributeKey ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { clientId, attributeKey, startOffset, endOffset } = this.relPos;\n\t\tconst absStartOffset = yjs.createAbsolutePositionFromRelativePosition( startOffset, doc )?.index;\n\t\tconst absEndOffset = yjs.createAbsolutePositionFromRelativePosition( endOffset, doc )?.index;\n\n\t\tif ( typeof absStartOffset !== 'number' || typeof absEndOffset !== 'number' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectionChange( clientId, attributeKey, absStartOffset, absEndOffset );\n\t}\n}\n\nexport class PeerRelativePosition {\n\t/**\n\t * @private\n\t * @type {RelativePosition[]}\n\t */\n\t_peerRelativePositions = [];\n\n\t/**\n\t * @param {() => Record<string, Partial<SelectionRange>>} getPeers\n\t * @param {(peerId: string, selection: SelectionRange) => void} setPeerSelection\n\t */\n\tconstructor( getPeers, setPeerSelection ) {\n\t\t/** @private */\n\t\tthis._getPeers = getPeers;\n\t\t/** @private */\n\t\tthis._setPeerSelection = setPeerSelection;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} peerId\n\t * @param {Partial<SelectionRange>} peer\n\t * @return {RelativePosition}\n\t */\n\t_initRelativePositionForPeer( peerId, peer ) {\n\t\treturn new RelativePosition(\n\t\t\t() => ( { start: peer.start ?? {}, end: peer.end ?? {} } ),\n\t\t\t( clientId, attributeKey, startOffset, endOffset ) =>\n\t\t\t\tthis._setPeerSelection( peerId, {\n\t\t\t\t\tstart: { clientId, attributeKey, offset: startOffset },\n\t\t\t\t\tend: { clientId, attributeKey, offset: endOffset },\n\t\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePositions( doc ) {\n\t\tthis._peerRelativePositions = Object.entries( this._getPeers() ).map( ( [ peerId, peer ] ) =>\n\t\t\tthis._initRelativePositionForPeer( peerId, peer )\n\t\t);\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.saveRelativePosition( doc ) );\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePositions( doc ) {\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.setAbsolutePosition( doc ) );\n\t}\n}\n"],"mappings":"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"}