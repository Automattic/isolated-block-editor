{"version":3,"file":"index.js","names":["_mutex","require","_uuid","_lodash","_yjsDoc","_data","_element","_filters","_formats","_yjsUndo","_relativePosition","debug","defaultColors","exports","initYDoc","_x","_initYDoc","apply","arguments","_asyncToGenerator2","_regenerator","mark","_callee","_ref","settings","registry","channelId","transport","dispatch","select","mutex","identity","doc","_yield$transport$conn","isFirstInChannel","_disconnect","wrap","_callee$","_context","prev","next","createMutex","uuidv4","concat","createDocument","relativePositionManager","self","RelativePosition","start","getSelectionStart","end","getSelectionEnd","selectionChange","peers","PeerRelativePosition","getCollabPeers","setCollabPeerSelection","sendMessage","message","type","onConnectionReady","once","setYDoc","setupUndoManager","getPostMap","onYDocTriggeredChange","changes","updateBlocksWithUndo","blocks","isTriggeredByYDoc","connect","user","name","username","color","caretColor","sample","avatarUrl","onReceiveMessage","data","receiveMessage","selection","setAvailablePeers","setAvailableCollabPeers","sent","startSharing","title","getBlocks","disconnect","window","addEventListener","abrupt","sendSelection","removeEventListener","stop","useYjs","_ref2","onSelectionChange","useRef","noop","useRegistry","_useSelect","useSelect","getFormatType","selectionStart","selectionEnd","useEffect","enabled","console","error","registerCollabFormats","addCollabFilters","onUnmount","then","_ref3","current"],"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { createMutex } from 'lib0/mutex';\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, once, sample } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport { createDocument } from './yjs-doc';\n\n/**\n * WordPress dependencies\n */\nimport { useRegistry, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\nimport { setupUndoManager } from './yjs-undo';\nimport { PeerRelativePosition, RelativePosition } from './algorithms/relative-position';\n\n// @ts-ignore\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n\nexport const defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {Object} opts\n * @param {import('..').CollaborationSettings} opts.settings\n * @param {Object} opts.registry - Redux data registry for this context.\n */\nasync function initYDoc( { settings, registry } ) {\n\tconst { channelId, transport } = settings;\n\tconst { dispatch, select } = registry;\n\tconst mutex = createMutex();\n\n\t/** @type {string} */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\trelativePositionManager: {\n\t\t\tself: new RelativePosition(\n\t\t\t\t() => ( {\n\t\t\t\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\t\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t\t\t} ),\n\t\t\t\tdispatch( 'core/block-editor' ).selectionChange\n\t\t\t),\n\t\t\tpeers: new PeerRelativePosition(\n\t\t\t\tselect( 'isolated/editor' ).getCollabPeers,\n\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection\n\t\t\t),\n\t\t},\n\t\t/** @param {Object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\t\t},\n\t} );\n\n\tdoc.onConnectionReady(\n\t\tonce( () => {\n\t\t\tdebug( 'Connection ready. Setting up ydoc document and undo manager' );\n\t\t\tdispatch( 'isolated/editor' ).setYDoc( doc );\n\t\t\tsetupUndoManager( doc.getPostMap(), identity, registry );\n\t\t} )\n\t);\n\n\tdoc.onYDocTriggeredChange( ( changes ) => {\n\t\tdebug( 'changes triggered by ydoc, applying to editor state', changes );\n\t\tdispatch( 'isolated/editor' ).updateBlocksWithUndo( changes.blocks, { isTriggeredByYDoc: true } );\n\t} );\n\n\tconst { isFirstInChannel } = await transport.connect( {\n\t\tuser: {\n\t\t\tidentity,\n\t\t\tname: settings.username,\n\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\tavatarUrl: settings.avatarUrl,\n\t\t},\n\t\t/** @param {import('..').CollaborationTransportMessage} data */\n\t\tonReceiveMessage: ( data ) => {\n\t\t\tdebug( 'remote change received by transport', data );\n\n\t\t\tswitch ( data.type ) {\n\t\t\t\tcase 'doc': {\n\t\t\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\t\t\tmutex( () => {\n\t\t\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'selection': {\n\t\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection( data.identity, data.selection );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tsetAvailablePeers: ( peers ) => {\n\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\tdispatch( 'isolated/editor' ).setAvailableCollabPeers( peers );\n\t\t},\n\t\tchannelId,\n\t} );\n\n\tdebug( `connected (channelId: ${ channelId })` );\n\n\tif ( isFirstInChannel ) {\n\t\tdebug( 'first in channel' );\n\n\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\tdoc.startSharing( { title: '', blocks: select( 'core/block-editor' ).getBlocks() } );\n\t} else {\n\t\tdoc.connect();\n\t}\n\n\tconst disconnect = () => {\n\t\ttransport.disconnect();\n\t\tdoc.disconnect();\n\t};\n\n\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\treturn {\n\t\tsendSelection: ( start, end ) => {\n\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\tmutex( () => {\n\t\t\t\tdebug( 'sendSelection', start, end );\n\t\t\t\ttransport.sendMessage( {\n\t\t\t\t\ttype: 'selection',\n\t\t\t\t\tidentity,\n\t\t\t\t\tselection: {\n\t\t\t\t\t\tstart,\n\t\t\t\t\t\tend,\n\t\t\t\t\t},\n\t\t\t\t} );\n\t\t\t} );\n\t\t},\n\t\tdisconnect: () => {\n\t\t\twindow.removeEventListener( 'beforeunload', disconnect );\n\t\t\tdisconnect();\n\t\t},\n\t};\n}\n\n/**\n * @param {Object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst onSelectionChange = useRef( noop );\n\tconst registry = useRegistry();\n\n\tconst { getFormatType, selectionStart, selectionEnd } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\t// @ts-ignore\n\t\t\tgetFormatType: select( 'core/rich-text' ).getFormatType,\n\t\t\t// @ts-ignore\n\t\t\tselectionStart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\t// @ts-ignore\n\t\t\tselectionEnd: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t};\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats( getFormatType );\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tsettings,\n\t\t\tregistry,\n\t\t} ).then( ( { sendSelection, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tonSelectionChange.current = sendSelection;\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tonSelectionChange.current( selectionStart, selectionEnd );\n\t}, [ selectionStart, selectionEnd ] );\n}\n"],"mappings":"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"}