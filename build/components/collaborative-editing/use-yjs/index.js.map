{"version":3,"file":"index.js","names":["debug","require","defaultColors","initYDoc","settings","registry","channelId","transport","dispatch","select","mutex","createMutex","identity","uuidv4","doc","createDocument","relativePositionManager","self","RelativePosition","start","getSelectionStart","end","getSelectionEnd","selectionChange","peers","PeerRelativePosition","getCollabPeers","setCollabPeerSelection","sendMessage","message","type","onConnectionReady","once","setYDoc","setupUndoManager","getPostMap","onYDocTriggeredChange","changes","updateBlocksWithUndo","blocks","isTriggeredByYDoc","connect","user","name","username","color","caretColor","sample","avatarUrl","onReceiveMessage","data","receiveMessage","selection","setAvailablePeers","setAvailableCollabPeers","isFirstInChannel","startSharing","title","getBlocks","disconnect","window","addEventListener","sendSelection","removeEventListener","useYjs","onSelectionChange","useRef","noop","useRegistry","useSelect","getFormatType","selectionStart","selectionEnd","useEffect","enabled","console","error","registerCollabFormats","addCollabFilters","onUnmount","then","current"],"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { createMutex } from 'lib0/mutex';\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, once, sample } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport { createDocument } from './yjs-doc';\n\n/**\n * WordPress dependencies\n */\nimport { useRegistry, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\nimport { setupUndoManager } from './yjs-undo';\nimport { PeerRelativePosition, RelativePosition } from './algorithms/relative-position';\n\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n\nexport const defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {Object} opts\n * @param {import('..').CollaborationSettings} opts.settings\n * @param {Object} opts.registry - Redux data registry for this context.\n */\nasync function initYDoc( { settings, registry } ) {\n\tconst { channelId, transport } = settings;\n\tconst { dispatch, select } = registry;\n\tconst mutex = createMutex();\n\n\t/** @type {string} */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\trelativePositionManager: {\n\t\t\tself: new RelativePosition(\n\t\t\t\t() => ( {\n\t\t\t\t\tstart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\t\t\tend: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t\t\t} ),\n\t\t\t\tdispatch( 'core/block-editor' ).selectionChange\n\t\t\t),\n\t\t\tpeers: new PeerRelativePosition(\n\t\t\t\tselect( 'isolated/editor' ).getCollabPeers,\n\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection\n\t\t\t),\n\t\t},\n\t\t/** @param {Object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\t\t},\n\t} );\n\n\tdoc.onConnectionReady(\n\t\tonce( () => {\n\t\t\tdebug( 'Connection ready. Setting up ydoc document and undo manager' );\n\t\t\tdispatch( 'isolated/editor' ).setYDoc( doc );\n\t\t\tsetupUndoManager( doc.getPostMap(), identity, registry );\n\t\t} )\n\t);\n\n\tdoc.onYDocTriggeredChange( ( changes ) => {\n\t\tdebug( 'changes triggered by ydoc, applying to editor state', changes );\n\t\tdispatch( 'isolated/editor' ).updateBlocksWithUndo( changes.blocks, { isTriggeredByYDoc: true } );\n\t} );\n\n\tconst { isFirstInChannel } = await transport.connect( {\n\t\tuser: {\n\t\t\tidentity,\n\t\t\tname: settings.username,\n\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\tavatarUrl: settings.avatarUrl,\n\t\t},\n\t\t/** @param {import('..').CollaborationTransportMessage} data */\n\t\tonReceiveMessage: ( data ) => {\n\t\t\tdebug( 'remote change received by transport', data );\n\n\t\t\tswitch ( data.type ) {\n\t\t\t\tcase 'doc': {\n\t\t\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\t\t\tmutex( () => {\n\t\t\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'selection': {\n\t\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection( data.identity, data.selection );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tsetAvailablePeers: ( peers ) => {\n\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\tdispatch( 'isolated/editor' ).setAvailableCollabPeers( peers );\n\t\t},\n\t\tchannelId,\n\t} );\n\n\tdebug( `connected (channelId: ${ channelId })` );\n\n\tif ( isFirstInChannel ) {\n\t\tdebug( 'first in channel' );\n\n\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\tdoc.startSharing( { title: '', blocks: select( 'core/block-editor' ).getBlocks() } );\n\t} else {\n\t\tdoc.connect();\n\t}\n\n\tconst disconnect = () => {\n\t\ttransport.disconnect();\n\t\tdoc.disconnect();\n\t};\n\n\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\treturn {\n\t\tsendSelection: ( start, end ) => {\n\t\t\t// The mutex wrapper prevents a remote change from triggering a selection change message\n\t\t\tmutex( () => {\n\t\t\t\tdebug( 'sendSelection', start, end );\n\t\t\t\ttransport.sendMessage( {\n\t\t\t\t\ttype: 'selection',\n\t\t\t\t\tidentity,\n\t\t\t\t\tselection: {\n\t\t\t\t\t\tstart,\n\t\t\t\t\t\tend,\n\t\t\t\t\t},\n\t\t\t\t} );\n\t\t\t} );\n\t\t},\n\t\tdisconnect: () => {\n\t\t\twindow.removeEventListener( 'beforeunload', disconnect );\n\t\t\tdisconnect();\n\t\t},\n\t};\n}\n\n/**\n * @param {Object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst onSelectionChange = useRef( noop );\n\tconst registry = useRegistry();\n\n\tconst { getFormatType, selectionStart, selectionEnd } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\tgetFormatType: select( 'core/rich-text' ).getFormatType,\n\t\t\tselectionStart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\tselectionEnd: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t};\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats( getFormatType );\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tsettings,\n\t\t\tregistry,\n\t\t} ).then( ( { sendSelection, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tonSelectionChange.current = sendSelection;\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tonSelectionChange.current( selectionStart, selectionEnd );\n\t}, [ selectionStart, selectionEnd ] );\n}\n"],"mappings":"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"}