{"version":3,"file":"yjs-doc.js","names":["yjs","_interopRequireWildcard","require","_yjs2","_excluded","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","_ref","identity","relativePositionManager","sendMessage","doc","Doc","state","yDocTriggeredChangeListeners","connectionReadyListeners","on","update","origin","peers","setAbsolutePositions","newData","postDocToObject","sanitize","forEach","listener","self","setAbsolutePosition","isLocalOrigin","concat","UndoManager","protocol","messageType","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","applyLocalChangesToYDoc","data","_ref2","arguments","length","undefined","_ref2$isInitialConten","isInitialContent","richTextHint","saveRelativePositions","transactionOrigin","transact","updatePostDoc","connect","disconnect","startSharing","receiveMessage","_ref3","content","_objectWithoutProperties2","encodeStateAsUpdate","applyUpdate","saveRelativePosition","onYDocTriggeredChange","push","filter","l","onConnectionReady","getState","getDoc","getPostMap","getMap"],"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-doc.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * Internal dependencies\n */\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/** @typedef {import('./algorithms/yjs').PostObject} PostObject */\n/** @typedef {import('./algorithms/relative-position').RelativePositionManager} RelativePositionManager */\n/** @typedef {import('..').RichTextHint} RichTextHint */\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\n/**\n * Create a Yjs document.\n *\n * @param {Object} opts\n * @param {RelativePositionManager} opts.relativePositionManager - Module to coordinate conversions between the block editor selection and Y.RelativePosition.\n * @param {string} opts.identity - Client identifier.\n * @param {function(Record<string, unknown>): void} opts.sendMessage\n */\nexport function createDocument( { identity, relativePositionManager, sendMessage } ) {\n\tconst doc = new yjs.Doc();\n\t/** @type {'off'|'connecting'|'on'} */\n\tlet state = 'off';\n\n\tlet yDocTriggeredChangeListeners = [];\n\tlet connectionReadyListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\trelativePositionManager.peers.setAbsolutePositions( doc );\n\n\t\t// Change received from peer, or triggered by self undo/redo\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = postDocToObject( doc, { sanitize: true } );\n\t\t\tyDocTriggeredChangeListeners.forEach( ( listener ) => listener( newData ) );\n\t\t\trelativePositionManager.self.setAbsolutePosition( doc );\n\t\t}\n\n\t\tconst isLocalOrigin =\n\t\t\torigin === identity || origin === `no-undo--${ identity }` || origin instanceof yjs.UndoManager;\n\n\t\t// Change should be broadcast to peers\n\t\tif ( isLocalOrigin && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\n\t\tif ( newState === 'on' ) {\n\t\t\tconnectionReadyListeners.forEach( ( listener ) => listener() );\n\t\t}\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\t/**\n\t\t * @param {PostObject} data\n\t\t * @param {Object} [opts]\n\t\t * @param {boolean} [opts.isInitialContent] Whether this is the initial content loaded from the editor onLoad.\n\t\t * @param {RichTextHint} [opts.richTextHint] Indication that a certain block attribute is a RichText, inferred from the current editor selection.\n\t\t */\n\t\t// @ts-ignore\n\t\tapplyLocalChangesToYDoc( data, { isInitialContent = false, richTextHint } = {} ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\trelativePositionManager.peers.saveRelativePositions( doc );\n\n\t\t\tconst transactionOrigin = isInitialContent ? `no-undo--${ identity }` : identity;\n\n\t\t\tdoc.transact( () => {\n\t\t\t\tupdatePostDoc( doc, data, richTextHint );\n\t\t\t}, transactionOrigin );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\n\t\t\tthis.applyLocalChangesToYDoc( data, { isInitialContent: true } );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif ( content.destination && content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray( yjs.encodeStateAsUpdate( doc, decodeArray( content.stateVector ) ) ),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\trelativePositionManager.self.saveRelativePosition( doc );\n\t\t\t\t\trelativePositionManager.peers.saveRelativePositions( doc );\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonYDocTriggeredChange( listener ) {\n\t\t\tyDocTriggeredChangeListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tyDocTriggeredChangeListeners = yDocTriggeredChangeListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonConnectionReady( listener ) {\n\t\t\tconnectionReadyListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tconnectionReadyListeners = connectionReadyListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\n\t\tgetDoc() {\n\t\t\treturn doc;\n\t\t},\n\n\t\tgetPostMap() {\n\t\t\treturn doc.getMap( 'post' );\n\t\t},\n\t};\n}\n"],"mappings":"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"}