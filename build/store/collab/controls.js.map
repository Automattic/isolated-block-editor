{"version":3,"file":"controls.js","names":["_reduxUndo","require","_data","_UPDATE_BLOCKS_WITH_U","debugUndo","getRichTextHint","registry","_registry$select$getS","select","getSelectionStart","clientId","attributeKey","undefined","applyChangesToYDoc","createRegistryControl","action","doc","getYDoc","isTriggeredByYDoc","applyLocalChangesToYDoc","blocks","isInitialContent","richTextHint","_default","UPDATE_BLOCKS_WITH_UNDO","UPDATE_BLOCKS_WITHOUT_UNDO","_defineProperty2","ActionCreators","undo","type","undoManager","getUndoManager","redo","exports"],"sources":["../../../src/store/collab/controls.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { ActionCreators } from 'redux-undo';\n\n/**\n * WordPress dependencies\n */\nimport { createRegistryControl } from '@wordpress/data';\n\nconst debugUndo = require( 'debug' )( 'iso-editor:collab:undo' );\n\n// TODO: Unsolved problem\n/**\n * Return the clientId and block attribute key if the current selection can be\n * associated with a RichText attribute.\n *\n * Caution: This won't return false positives, but it will return false negatives.\n * Currently the only way of telling whether a given block attribute is associated with a `<RichText>`\n * in the editor is for it to be passed an `identifier` prop with the block attribute key,\n * e.g. `<RichText identifier=\"myAttributeKey\" />`. If the block developer has neglected to do this,\n * the selection.attributeKey will fall back to a `number`, and we can't tell which attribute it's\n * actually associated with. This happens a lot because the `identifier` prop is undocumented.\n *\n * @param registry\n * @return {import('../../components/collaborative-editing').RichTextHint|undefined}\n */\nconst getRichTextHint = ( registry ) => {\n\tconst { clientId, attributeKey } = registry.select( 'core/block-editor' ).getSelectionStart();\n\n\t// If the selection has an attribute key that is a string, we can deduce that the attribute is a RichText\n\treturn typeof attributeKey === 'string' ? { clientId, attributeKey } : undefined;\n};\n\nconst applyChangesToYDoc = createRegistryControl( ( registry ) => ( action ) => {\n\tconst doc = registry.select( 'isolated/editor' ).getYDoc();\n\n\t// If the change is triggered locally from the editor (i.e. is neither a remote change nor an undo/redo),\n\t// apply those changes to the Yjs doc.\n\tif ( doc && ! action.isTriggeredByYDoc ) {\n\t\tdoc.applyLocalChangesToYDoc(\n\t\t\t{ blocks: action.blocks },\n\t\t\t{\n\t\t\t\tisInitialContent: action.isInitialContent,\n\t\t\t\trichTextHint: getRichTextHint( registry ),\n\t\t\t}\n\t\t);\n\t}\n\n\treturn action;\n} );\n\nexport default {\n\tUPDATE_BLOCKS_WITH_UNDO: applyChangesToYDoc,\n\tUPDATE_BLOCKS_WITHOUT_UNDO: applyChangesToYDoc,\n\n\t[ ActionCreators.undo().type ]: createRegistryControl( ( registry ) => ( action ) => {\n\t\tconst undoManager = registry.select( 'isolated/editor' ).getUndoManager();\n\n\t\tif ( ! undoManager ) {\n\t\t\tdebugUndo( 'Undoing from redux-undo state' );\n\t\t\treturn action;\n\t\t}\n\t\tdebugUndo( 'Undoing from yjs undoManager' );\n\n\t\tdebugUndo( 'undo' );\n\t\tundoManager.undo();\n\t\treturn undefined; // prevent default action\n\t} ),\n\n\t[ ActionCreators.redo().type ]: createRegistryControl( ( registry ) => ( action ) => {\n\t\tconst undoManager = registry.select( 'isolated/editor' ).getUndoManager();\n\n\t\tif ( ! undoManager ) {\n\t\t\treturn action;\n\t\t}\n\n\t\tdebugUndo( 'redo' );\n\t\tregistry.select( 'isolated/editor' ).getUndoManager().redo();\n\t\treturn undefined; // prevent default action\n\t} ),\n};\n"],"mappings":";;;;;;;;AAGA,IAAAA,UAAA,GAAAC,OAAA;AAKA,IAAAC,KAAA,GAAAD,OAAA;AAAwD,IAAAE,qBAAA;AARxD;AACA;AACA;AAGA;AACA;AACA;AAGA,IAAMC,SAAS,GAAGH,OAAO,CAAE,OAAQ,CAAC,CAAE,wBAAyB,CAAC;;AAEhE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAMI,eAAe,GAAG,SAAlBA,eAAeA,CAAKC,QAAQ,EAAM;EACvC,IAAAC,qBAAA,GAAmCD,QAAQ,CAACE,MAAM,CAAE,mBAAoB,CAAC,CAACC,iBAAiB,CAAC,CAAC;IAArFC,QAAQ,GAAAH,qBAAA,CAARG,QAAQ;IAAEC,YAAY,GAAAJ,qBAAA,CAAZI,YAAY;;EAE9B;EACA,OAAO,OAAOA,YAAY,KAAK,QAAQ,GAAG;IAAED,QAAQ,EAARA,QAAQ;IAAEC,YAAY,EAAZA;EAAa,CAAC,GAAGC,SAAS;AACjF,CAAC;AAED,IAAMC,kBAAkB,GAAG,IAAAC,2BAAqB,EAAE,UAAER,QAAQ;EAAA,OAAM,UAAES,MAAM,EAAM;IAC/E,IAAMC,GAAG,GAAGV,QAAQ,CAACE,MAAM,CAAE,iBAAkB,CAAC,CAACS,OAAO,CAAC,CAAC;;IAE1D;IACA;IACA,IAAKD,GAAG,IAAI,CAAED,MAAM,CAACG,iBAAiB,EAAG;MACxCF,GAAG,CAACG,uBAAuB,CAC1B;QAAEC,MAAM,EAAEL,MAAM,CAACK;MAAO,CAAC,EACzB;QACCC,gBAAgB,EAAEN,MAAM,CAACM,gBAAgB;QACzCC,YAAY,EAAEjB,eAAe,CAAEC,QAAS;MACzC,CACD,CAAC;IACF;IAEA,OAAOS,MAAM;EACd,CAAC;AAAA,CAAC,CAAC;AAAC,IAAAQ,QAAA,IAAApB,qBAAA;EAGHqB,uBAAuB,EAAEX,kBAAkB;EAC3CY,0BAA0B,EAAEZ;AAAkB,OAAAa,gBAAA,aAAAvB,qBAAA,EAE5CwB,yBAAc,CAACC,IAAI,CAAC,CAAC,CAACC,IAAI,EAAI,IAAAf,2BAAqB,EAAE,UAAER,QAAQ;EAAA,OAAM,UAAES,MAAM,EAAM;IACpF,IAAMe,WAAW,GAAGxB,QAAQ,CAACE,MAAM,CAAE,iBAAkB,CAAC,CAACuB,cAAc,CAAC,CAAC;IAEzE,IAAK,CAAED,WAAW,EAAG;MACpB1B,SAAS,CAAE,+BAAgC,CAAC;MAC5C,OAAOW,MAAM;IACd;IACAX,SAAS,CAAE,8BAA+B,CAAC;IAE3CA,SAAS,CAAE,MAAO,CAAC;IACnB0B,WAAW,CAACF,IAAI,CAAC,CAAC;IAClB,OAAOhB,SAAS,CAAC,CAAC;EACnB,CAAC;AAAA,CAAC,CAAC,OAAAc,gBAAA,aAAAvB,qBAAA,EAEDwB,yBAAc,CAACK,IAAI,CAAC,CAAC,CAACH,IAAI,EAAI,IAAAf,2BAAqB,EAAE,UAAER,QAAQ;EAAA,OAAM,UAAES,MAAM,EAAM;IACpF,IAAMe,WAAW,GAAGxB,QAAQ,CAACE,MAAM,CAAE,iBAAkB,CAAC,CAACuB,cAAc,CAAC,CAAC;IAEzE,IAAK,CAAED,WAAW,EAAG;MACpB,OAAOf,MAAM;IACd;IAEAX,SAAS,CAAE,MAAO,CAAC;IACnBE,QAAQ,CAACE,MAAM,CAAE,iBAAkB,CAAC,CAACuB,cAAc,CAAC,CAAC,CAACC,IAAI,CAAC,CAAC;IAC5D,OAAOpB,SAAS,CAAC,CAAC;EACnB,CAAC;AAAA,CAAC,CAAC,GAAAT,qBAAA;AAAA8B,OAAA,cAAAV,QAAA"}